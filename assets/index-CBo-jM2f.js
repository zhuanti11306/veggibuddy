import{a as t,p as e,I as s,f as a,s as i,c as n,o as r,t as o,i as c,k as l,l as d,w as h,x as u,d as v}from"./index-B74hZ3uX.js";import{z as f,A as p,E as g,B as E,C as m,P as w,D as b,F as y,G as R,q as k,s as C,d as A,y as L}from"./index-BruxziNw.js";class S extends EventTarget{static audioContext;static communications=new Map;readyState="loading";socket;token;currentAudio;isResponding=!1;autoPlay=!0;constructor(t){super(),this.initializeConnection(t)}async initializeConnection(t){try{const e=await Promise.resolve(t);this.token=e,S.communications.has(e)?this.socket=S.communications.get(e):(this.socket=new WebSocket(`${g.API.WS_BASE_URL}/response/${e}`),S.communications.set(e,this.socket)),this.socket?.readyState===WebSocket.OPEN?this.setupSocketHandlers():this.socket?.addEventListener("open",()=>this.setupSocketHandlers())}catch(e){this.readyState="error",this.dispatchEvent(new CustomEvent("error",{detail:e}))}}setupSocketHandlers(){this.socket&&(this.readyState="ready",this.dispatchEvent(new CustomEvent("ready")),this.socket.addEventListener("message",async t=>{const e=JSON.parse(t.data);if(this.dispatchEvent(new CustomEvent("message",{detail:e})),this.dispatchEvent(new CustomEvent("received",{detail:e.emotion})),!this.autoPlay)return;const s=await this.playAudio(e.audio);s&&(await s.promise,this.dispatchEvent(new CustomEvent("played",{detail:e.emotion})))}),this.socket.addEventListener("close",()=>{this.readyState="error"}),this.socket.addEventListener("error",t=>{this.readyState="error"}))}async playAudio(t){try{const e=atob(t),s=new Uint8Array(e.length);for(let t=0;t<e.length;t++)s[t]=e.charCodeAt(t);const a=this.getAudioContext(),i=await a.decodeAudioData(s.buffer);this.currentAudio?.stop(),this.currentAudio=a.createBufferSource(),this.currentAudio.buffer=i,this.currentAudio.connect(a.destination);return{promise:new Promise(t=>{this.currentAudio.onended=()=>{this.currentAudio=void 0,t()},this.currentAudio.start(0)})}}catch(e){}finally{this.isResponding=!1}}getAudioContext(){return S.audioContext||(S.audioContext=new AudioContext),S.audioContext}canSendMessage(){return!!this.socket&&("ready"===this.readyState&&!this.isResponding)}async waitForReady(){return"ready"!==this.readyState||this.isResponding?new Promise((t,e)=>{const s=()=>{"ready"!==this.readyState||this.isResponding||(this.removeEventListener("ready",s),this.removeEventListener("received",s),t(this))},a=t=>{this.removeEventListener("ready",s),this.removeEventListener("received",s),this.removeEventListener("error",a),e(t.detail)};this.addEventListener("ready",s),this.addEventListener("received",s),this.addEventListener("error",a)}):this}sendAudio(t){return!!this.canSendMessage()&&(this.socket.send(t),this.isResponding=!0,!0)}async sendAudioAndWait(t){if(await this.waitForReady(),!this.sendAudio(t))throw new Error("無法發送音訊");const e=new Promise(t=>{this.addEventListener("received",e=>t(e.detail),{once:!0})}),s=this.autoPlay?new Promise(t=>{this.addEventListener("played",()=>t(),{once:!0})}):Promise.resolve();return{emotion:await e,played:s}}close(){this.socket&&this.token&&(this.socket.close(),S.communications.delete(this.token),this.socket=void 0),this.currentAudio?.stop(),this.currentAudio=void 0}}class D{static instance;static getConversation(){if(!this.instance){const t=f(p.chatGetToken).then(t=>t.session_token);this.instance=new S(t)}return this.instance}static closeConversation(){this.instance&&(this.instance.close(),this.instance=void 0)}}var F,I;(I=F||(F={})).LOAD="LOAD",I.EXEC="EXEC",I.FFPROBE="FFPROBE",I.WRITE_FILE="WRITE_FILE",I.READ_FILE="READ_FILE",I.DELETE_FILE="DELETE_FILE",I.RENAME="RENAME",I.CREATE_DIR="CREATE_DIR",I.LIST_DIR="LIST_DIR",I.DELETE_DIR="DELETE_DIR",I.ERROR="ERROR",I.DOWNLOAD="DOWNLOAD",I.PROGRESS="PROGRESS",I.LOG="LOG",I.MOUNT="MOUNT",I.UNMOUNT="UNMOUNT";const j=(()=>{let t=0;return()=>t++})(),O=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),_=new Error("called FFmpeg.terminate()");var x,P;(P=x||(x={})).MEMFS="MEMFS",P.NODEFS="NODEFS",P.NODERAWFS="NODERAWFS",P.IDBFS="IDBFS",P.WORKERFS="WORKERFS",P.PROXYFS="PROXYFS";const T=new Error("failed to get response body reader"),M=new Error("failed to complete download"),B=async(t,e,s=!1,a)=>{const i=s?await(async(t,e)=>{const s=await fetch(t);let a;try{const i=parseInt(s.headers.get("Content-Length")||"-1"),n=s.body?.getReader();if(!n)throw T;const r=[];let o=0;for(;;){const{done:s,value:a}=await n.read(),c=a?a.length:0;if(s){if(-1!=i&&i!==o)throw M;e&&e({url:t,total:i,received:o,delta:c,done:s});break}r.push(a),o+=c,e&&e({url:t,total:i,received:o,delta:c,done:s})}const c=new Uint8Array(o);let l=0;for(const t of r)c.set(t,l),l+=t.length;a=c.buffer}catch(i){a=await s.arrayBuffer()}return a})(t,a):await(await fetch(t)).arrayBuffer(),n=new Blob([i],{type:e});return URL.createObjectURL(n)},W=new class{#t=null;#e={};#s={};#a=[];#i=[];loaded=!1;#n=()=>{this.#t&&(this.#t.onmessage=({data:{id:t,type:e,data:s}})=>{switch(e){case F.LOAD:this.loaded=!0,this.#e[t](s);break;case F.MOUNT:case F.UNMOUNT:case F.EXEC:case F.FFPROBE:case F.WRITE_FILE:case F.READ_FILE:case F.DELETE_FILE:case F.RENAME:case F.CREATE_DIR:case F.LIST_DIR:case F.DELETE_DIR:this.#e[t](s);break;case F.LOG:this.#a.forEach(t=>t(s));break;case F.PROGRESS:this.#i.forEach(t=>t(s));break;case F.ERROR:this.#s[t](s)}delete this.#e[t],delete this.#s[t]})};#r=({type:t,data:e},s=[],a)=>this.#t?new Promise((i,n)=>{const r=j();this.#t&&this.#t.postMessage({id:r,type:t,data:e},s),this.#e[r]=i,this.#s[r]=n,a?.addEventListener("abort",()=>{n(new DOMException(`Message # ${r} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(O);on(t,e){"log"===t?this.#a.push(e):"progress"===t&&this.#i.push(e)}off(t,e){"log"===t?this.#a=this.#a.filter(t=>t!==e):"progress"===t&&(this.#i=this.#i.filter(t=>t!==e))}load=({classWorkerURL:t,...e}={},{signal:s}={})=>(this.#t||(this.#t=t?new Worker(new URL(t,import.meta.url),{type:"module"}):new Worker(new URL("/assets/worker-BU9fmUEi.js",import.meta.url),{type:"module"}),this.#n()),this.#r({type:F.LOAD,data:e},void 0,s));exec=(t,e=-1,{signal:s}={})=>this.#r({type:F.EXEC,data:{args:t,timeout:e}},void 0,s);ffprobe=(t,e=-1,{signal:s}={})=>this.#r({type:F.FFPROBE,data:{args:t,timeout:e}},void 0,s);terminate=()=>{const t=Object.keys(this.#s);for(const e of t)this.#s[e](_),delete this.#s[e],delete this.#e[e];this.#t&&(this.#t.terminate(),this.#t=null,this.loaded=!1)};writeFile=(t,e,{signal:s}={})=>{const a=[];return e instanceof Uint8Array&&a.push(e.buffer),this.#r({type:F.WRITE_FILE,data:{path:t,data:e}},a,s)};mount=(t,e,s)=>this.#r({type:F.MOUNT,data:{fsType:t,options:e,mountPoint:s}},[]);unmount=t=>this.#r({type:F.UNMOUNT,data:{mountPoint:t}},[]);readFile=(t,e="binary",{signal:s}={})=>this.#r({type:F.READ_FILE,data:{path:t,encoding:e}},void 0,s);deleteFile=(t,{signal:e}={})=>this.#r({type:F.DELETE_FILE,data:{path:t}},void 0,e);rename=(t,e,{signal:s}={})=>this.#r({type:F.RENAME,data:{oldPath:t,newPath:e}},void 0,s);createDir=(t,{signal:e}={})=>this.#r({type:F.CREATE_DIR,data:{path:t}},void 0,e);listDir=(t,{signal:e}={})=>this.#r({type:F.LIST_DIR,data:{path:t}},void 0,e);deleteDir=(t,{signal:e}={})=>this.#r({type:F.DELETE_DIR,data:{path:t}},void 0,e)},U={coreURL:await B("https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/esm/ffmpeg-core.js","text/javascript"),wasmURL:await B("https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/esm/ffmpeg-core.wasm","application/wasm")};const N="input.webm",G="output.mp3";async function z(t,e){if(!1===W.loaded)return null;await W.writeFile(N,new Uint8Array(await t.arrayBuffer()),{signal:e}),await W.exec(["-i",N,G],-1,{signal:e});const s=await W.readFile(G,"binary",{signal:e});return await async function(){return async function(t){const e=await Promise.allSettled(t.map(t=>W.deleteFile(t)));for(const s of e)s.status}([N,G])}(),s instanceof Uint8Array?s:null}class H{static defaultOptions={clearWhenDraw:!0,barColor:"black",barWidth:3,barGap:1,fftsize:2048,durationSec:.5};canvas;context;options;stream=null;audioContext=null;analyser=null;dataChunk=null;waveformBuffer=null;bufferHead=0;constructor(t,e,s){if(this.canvas=t,this.context=e,e.canvas!==t)throw new Error("Canvas and context do not match.");this.options={...H.defaultOptions,...s}}setStream(t){this.stream=t,this.audioContext=new AudioContext;const e=this.audioContext.createMediaStreamSource(this.stream);this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.options.fftsize,this.dataChunk=new Float32Array(this.analyser.frequencyBinCount);const s=this.audioContext.sampleRate,a=this.options.durationSec??.5,i=Math.ceil(s*a);this.waveformBuffer=new Float32Array(i),this.bufferHead=0,e.connect(this.analyser)}setFFTSize(t){this.options.fftsize=t,this.analyser&&(this.analyser.fftSize=t,this.dataChunk&&(this.dataChunk=new Float32Array(this.analyser.frequencyBinCount)))}setDuration(t){if(this.options.durationSec=t,this.audioContext&&this.waveformBuffer){const e=this.audioContext.sampleRate,s=Math.ceil(e*t);this.waveformBuffer=new Float32Array(s),this.bufferHead=0}}toggleClearWhenDraw(t){this.options.clearWhenDraw=t??!this.options.clearWhenDraw}setBarColor(t){this.options.barColor=t}setBarWidth(t){this.options.barWidth=t}setBarGap(t){this.options.barGap=t}draw(){const t=this.context,e=this.canvas.width,s=this.canvas.height;(this.options.clearWhenDraw??1)&&t.clearRect(0,0,e,s),t.save();const a=this.options.barWidth+this.options.barGap,i=Math.floor(e/a);this.analyser&&this.dataChunk&&this.waveformBuffer?this.drawWaveform(i):this.drawWaiting(i),t.restore()}destroy(){if(this.stream){for(const t of this.stream.getTracks())this.stream.removeTrack(t);this.stream=null}this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.analyser&&(this.analyser.disconnect(),this.analyser=null)}waitingLineOffset=0;drawWaiting(t){const e=[];this.waitingLineOffset=(this.waitingLineOffset+.25)%t;for(let s=0;s<t;s++){const a=(s+this.waitingLineOffset)%t-t/2,i=1.05**(-a*a)*.5*Math.sin(a/5+s/3),n=this.canvas.height/2*(1-i),r=this.canvas.height/2;e.push([n,r])}this.drawLines(e)}drawWaveform(t){if(!this.analyser||!this.dataChunk||!this.waveformBuffer)return;this.canvas.width;const e=this.canvas.height;this.analyser.getFloatTimeDomainData(this.dataChunk);for(let n=0;n<this.dataChunk.length;n++)this.waveformBuffer[this.bufferHead]=this.dataChunk[n],this.bufferHead=(this.bufferHead+1)%this.waveformBuffer.length;const s=this.waveformBuffer.length,a=Math.floor(s/t),i=[];for(let n=0;n<t;n++){const t=n*a;let r=0;for(let e=0;e<a;e++){const a=(this.bufferHead+t+e)%s,i=Math.abs(this.waveformBuffer[a]);i>r&&(r=i)}const o=Math.max(r,.0078625)*e,c=e/2-o/2,l=e/2+o/2;i.push([c,l])}this.drawLines(i)}drawLines(t){const e=this.context,s=this.canvas.width;e.lineWidth=this.options.barWidth,e.strokeStyle=this.options.barColor,e.lineCap="round";const a=this.options.barWidth+this.options.barGap,i=(s-Math.floor(s/a)*a)/2+this.options.barGap;for(let n=0;n<t.length;n++){const s=t[n][0],r=t[n][1],o=n*a+i;e.beginPath(),e.moveTo(o,s),e.lineTo(o,r),e.stroke()}}}var $,X=(($=X||{})[$.Success=0]="Success",$[$.Ungranted=1]="Ungranted",$[$.Failed=2]="Failed",$);const Y=t({seconds:-1,interval:null,get formatted(){if(this.seconds<0)return"-- : --";return`${Math.floor(this.seconds/60).toString().padStart(2,"0")} : ${(this.seconds%60).toString().padStart(2,"0")}`},start(){this.resume(),this.seconds=0},stop(){this.pause(),this.seconds=-1},resume(){this.interval||(this.interval=setInterval(()=>this.seconds+=1,1e3))},pause(){this.interval&&(clearInterval(this.interval),this.interval=null)}}),q=[];var V=(t=>(t.Voice="voice",t.Sound="sound",t))(V||{});const K=t({state:4,initializing:!1,recorderInstance:null,READY:0,RECORDING:1,PAUSED:2,PROCESSING:3,UNGRANTED:4,FAILED:5,get instance(){return this.recorderInstance},set instance(t){t?(q.length=0,this.recorderInstance=t,t.ondataavailable=t=>{q.push(t.data)}):this.recorderInstance&&(this.recorderInstance.onstop=null,this.recorderInstance.ondataavailable=null,this.recorderInstance.stop())},get blob(){return new Blob(q,{type:"audio/webm"})},startRecording:function(){if(0!==K.state)return;if(!J)return;K.instance=new MediaRecorder(J),K.instance.start(),Z?.setBarColor("red"),Y.seconds=0,Y.interval=setInterval(()=>Y.seconds+=1,1e3),K.state=1},stopRecording:function(t=!0){if(1!==K.state&&2!==K.state)return;if(!K.instance||!t)return K?.instance?.stop(),K.instance=null,K.state=0,Z?.setBarColor("gray"),Y.stop(),void(Y.seconds=-1);K.instance.onstop=async()=>{if(!Q)return K.state=0,void(K.instance=null);const t=await z(K.blob).catch(t=>(K.state=0,null));if(!(t instanceof Uint8Array))return void(K.state=0);const e=new Blob([t],{type:"audio/mpeg"}),{emotion:s,played:a}=await(Q?.sendAudioAndWait(e));if(E(s),"voice"===K.mode)await a;else{const t=Math.random()<.5?2:3;for(let e=0;e<t;e++)await m(void 0,0)}K.instance=null,K.state=0,E(w.neutral)},K.instance.stop(),Z?.setBarColor("gray"),Y.stop(),K.state=3},pauseRecording:function(){if(1!==K.state)return;if(!K.instance)return;K.instance.pause(),K.state=2,Z?.setBarColor("gray"),Y.pause()},resumeRecording:function(){if(2!==K.state)return;if(!K.instance)return;K.instance.resume(),K.state=1,Z?.setBarColor("red"),Y.resume()},initialize:tt,mode:"voice",toggleMode(){switch(this.mode){case"voice":this.mode="sound",Q&&(Q.autoPlay=!1);break;case"sound":this.mode="voice",Q&&(Q.autoPlay=!0)}}});let J=null,Q=null,Z=null;async function tt(){if(4!==K.state)return;if(K.initializing)return;if(!("mediaDevices"in navigator))return void(K.state=5);const t=navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>({stream:t,result:0})).catch(t=>({error:t,result:1})),e=D.getConversation().waitForReady().then(t=>({conversation:t,result:0})).catch(t=>({error:t,result:2})),s=W.loaded?Promise.resolve({result:0}):async function(){return!!W.loaded||W.load(U).then(()=>!0).catch(t=>!1)}().then(t=>({result:t?0:2})).catch(t=>({error:t,result:2}));K.initializing=!0;const a=await Promise.all([t,e,s]),[i,n]=a;switch(a.reduce((t,e)=>Math.max(e.result,t),0)){case 0:J=i.stream,r=n.conversation,Q=r,K.state=0,Z?.setStream(J);break;case 1:K.state=4;break;case 2:K.state=5}var r;K.initializing=!1}const et={barColor:"gray",barWidth:5,barGap:5};var st=()=>history.back(),at=a('<div class="button-list"><button class="button svelte-g952jj">返回</button> <button class="button svelte-g952jj">開始錄音</button></div>'),it=()=>history.back(),nt=a('<div class="button-list"><button class="button svelte-g952jj">返回</button> <button class="button svelte-g952jj">開始</button></div>'),rt=()=>K.pauseRecording(),ot=()=>K.stopRecording(!0),ct=a('<div class="button-list"><button class="button svelte-g952jj">暫停</button> <button class="button svelte-g952jj">送出</button></div>'),lt=()=>K.resumeRecording(),dt=()=>K.stopRecording(!1),ht=()=>K.stopRecording(!0),ut=a('<div class="button-list"><button class="button svelte-g952jj">繼續</button> <button class="button svelte-g952jj">終止</button> <button class="button svelte-g952jj">送出</button></div>'),vt=()=>history.back(),ft=a('<div class="button-list"><button class="button svelte-g952jj">返回</button> <button class="button svelte-g952jj" disabled>開始錄音</button></div>'),pt=()=>K.toggleMode(),gt=a('<div class="container svelte-g952jj"><div class="canvas-container svelte-g952jj"><div class="timer svelte-g952jj"> </div> <canvas class="svelte-g952jj"></canvas></div> <!> <button type="button" class="toggler svelte-g952jj"><img alt="翻譯機" draggable="false" class="svelte-g952jj"/> <span class="label svelte-g952jj"> </span></button></div>');function Et(t,a){e(a,!1),s();var v=gt(),f=n(v),p=n(f),g=n(p),E=i(p,2);k(E,t=>function(t){const e=new ResizeObserver(()=>{const e=t.clientWidth??0,s=t.clientHeight??0;t.width=e*devicePixelRatio,t.height=s*devicePixelRatio,t.style.width=`${e}px`,t.style.height=`${s}px`});e.observe(t);const s=Z=new H(t,t.getContext("2d"),et),a=()=>s.draw();return b(a),K.state=4,tt(),y(!0),{destroy(){e.unobserve(t),s.destroy(),R(a)}}}?.(t));var m=i(f,2),w=t=>{var e=at(),s=n(e);s.__click=[st];var a=i(s,2);a.__click=function(...t){K.initialize?.apply(this,t)},o(()=>a.disabled=K.initializing),l(t,e)},S=t=>{var e=h(),s=u(e),a=t=>{var e=nt(),s=n(e);s.__click=[it],i(s,2).__click=function(...t){K.startRecording?.apply(this,t)},l(t,e)},o=t=>{var e=h(),s=u(e),a=t=>{var e=ct(),s=n(e);s.__click=[rt],i(s,2).__click=[ot],l(t,e)},o=t=>{var e=h(),s=u(e),a=t=>{var e=ut(),s=n(e);s.__click=[lt];var a=i(s,2);a.__click=[dt],i(a,2).__click=[ht],l(t,e)},o=t=>{var e=h(),s=u(e),a=t=>{var e=ft();n(e).__click=[vt],l(t,e)};r(s,t=>{K.state!==K.PROCESSING&&K.state!==K.FAILED||t(a)},!0),l(t,e)};r(s,t=>{K.state===K.PAUSED?t(a):t(o,!1)},!0),l(t,e)};r(s,t=>{K.state===K.RECORDING?t(a):t(o,!1)},!0),l(t,e)};r(s,t=>{K.state===K.READY?t(a):t(o,!1)},!0),l(t,e)};r(m,t=>{K.state===K.UNGRANTED?t(w):t(S,!1)});var D=i(m,2);D.__click=[pt];var F=n(D);let I;var j=i(F,2),O=n(j);o(t=>{c(g,K.state===K.FAILED?"出現未知錯誤":Y.formatted),C(F,"src",L.chat.src),I=A(F,"",I,t),c(O,"翻譯："+(K.mode===V.Voice?"開":"關"))},[()=>({filter:K.mode===V.Voice?"none":"grayscale(100%)"})]),l(t,v),d()}v(["click"]);export{Et as default};
