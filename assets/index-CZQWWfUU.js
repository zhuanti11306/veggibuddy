import{M as O,B as k,N as j,O as tt,y as F,Q as et,p as G,S as X,R as D,o as A,L as nt}from"./settings.svelte-F3Kr-02P.js";import{o as at}from"./dialogs-Cklb8uX6.js";import{g as ot}from"./index-mte2rPOm.js";import{p as N,q as st,F as it,h as H,t as rt,m as lt,b as U,g as Q,M as ct,j as M,w as ut,V as l,R as gt,S as mt,T as pt,U as dt,W as ht,X as vt,Y as ft,Z as W,i as wt,C as x,l as _,O as R,G as bt,A as yt,d as St,H as V}from"./vendor-BHUJVZvY.js";var Tt=H('<div class="svelte-qsraim"></div>');function Pt(e,n){N(n,!0),st(n,"direction",3,"portrait"),it(()=>(n.closeDialog,n.promise.then(()=>n.closeDialog?.()),()=>null));var t=Tt();rt(3,t,()=>lt),U(e,t),Q()}function Ct(e,n){at(Pt,{props:{promise:e}}).then(()=>ot(n))}function E(e,n,t){const a=t.clone().multiplyScalar(.5),c=n.clone(),m=e.clone();return{getTangent(r){return a.clone().multiplyScalar(2*r).add(c)},getPosition(r){const o=a.clone().multiplyScalar(r*r),i=c.clone().multiplyScalar(r);return o.add(i).add(m)},step(r,o,i){const u=[];for(let g=0;g<=i;g++){const s=r+(o-r)*g/i;u.push(this.getPosition(s))}return u}}}function Lt(e,n,t,a,c="low"){const m=t.clone().multiplyScalar(.5),r=n.clone().sub(e),o=r.lengthSq(),i=m.lengthSq(),u=r.dot(t),g=i,s=a*a+u,w=o,v=s*s-4*g*w;if(v<0)return null;const p=Math.sqrt(v),y=(s+(c==="high"?1:-1)*p)/(2*g);if(y<0)return null;const C=Math.sqrt(y),f=r.clone().multiplyScalar(1/C).sub(m.clone().multiplyScalar(C));return{duration:C,...E(e,f,t)}}const Y=new l(0,-9.81,0);let P=null;const{promise:Ht,resolve:kt}=Promise.withResolvers(),Bt=tt.throwingGame.models.field,B=32/900,I=ut(()=>G.isLegal?{id:G.type,assets:et[G.type]}:null),{promise:_t,resolve:zt}=Promise.withResolvers();let q=null;function At(){ct(()=>{if(!M(I))return;const e=M(I).id,n=M(I).assets;O(e).then(()=>{const t=P?.scene;if(!t)return;const a=n.model.object;a&&(a.position.set(0,0,.5),a.lookAt(new l(0,0,0)),a.visible=!0,t.add(a)),q?.model.object&&q!==n&&t.remove(q.model.object),q=n,zt(n)})})}const S={_state:0,start:{x:0,y:0},current:{x:0,y:0},get state(){return this._state},set state(e){if(this._state=e,!!P)switch(e){case 0:case 1:P.controls.enabled=!0;break;case 2:P.controls.enabled=!1;break}}};function xt(e,n,t){D.setFromCamera(e,n),D.intersectObject(t).length?(S.state=2,S.start.x=S.current.x=e.x,S.start.y=S.current.y=e.y):S.state=0}const Vt=function(e){const n=e.querySelector("canvas");if(!n)throw new Error("Canvas element not found in container.");const t=P=j(e,n,X.throwingBallGame);kt(t);const a=qt(t.scene);let c=null;return Promise.all([Bt.whenLoaded,_t]).then(([m,r])=>{t.info.gyroTuner.enable();const o=r.model.object,{animation:i,animationState:u,reset:g}=Dt(o,a);function s(p){const d=new W(p.offsetX,p.offsetY).applyMatrix3(t.pointerNormalize);xt(d,t.camera,a.ball)}function w(p){switch(S.state){case 0:break;case 2:{const{offsetX:d,offsetY:y}=p;S.current.x=d,S.current.y=y;const C=new W(d,y).applyMatrix3(t.pointerNormalize),f=new l,T=a.ball.position.distanceTo(t.camera.position);D.setFromCamera(C,t.camera),D.ray.at(T,f);const h=Y,b=a.ball.position.clone(),L=new l().subVectors(b,f).multiply(new l(8,16,8)).multiplyScalar(1/T),z=new l(L.x,0,L.z),K=2;if(z.length()>K&&(z.setLength(K),L.x=z.x,L.z=z.z),L.y>2&&(L.y=2),L.length()>=.0625){u.predictParabolaCurve=E(b,L,h);const $=u.predictParabolaCurve.step(0,.375,20);a.parabolaLine.geometry.setFromPoints($),a.parabolaLine.computeLineDistances(),a.parabolaLine.geometry.attributes.position.needsUpdate=!0,a.parabolaLine.visible=!0}break}}}function v(p){switch(S.state){case 0:break;case 2:a.parabolaLine.visible=!1,u.throwParabolaCurve=u.predictParabolaCurve,u.predictParabolaCurve=null,u.hadFirstThrow=!0}S.state=0}F(i),e.addEventListener("pointerdown",s),e.addEventListener("pointermove",w),e.addEventListener("pointerup",v),c=()=>{k(i),u.moving?.animation&&k(u.moving.animation),e.removeEventListener("pointerdown",s),e.removeEventListener("pointermove",w),e.removeEventListener("pointerup",v)},Z=()=>{g(),o.position.set(0,0,.5),o.lookAt(new l(0,0,0)),o.scale.set(B,B,B),a.ball.position.set(0,.025,.25),a.parabolaLine.visible=!1,t.camera.position.set(0,.0859375,-1/2**12),t.camera.lookAt(new l(0,.0859375,1)),t.controls.target.set(0,.0859375,0)}}),{destroy(){t.dispose(),c?.()}}};function qt(e){const n=new gt(new mt(.025,16,16),new pt({color:16733525,roughness:.5,metalness:0}));n.castShadow=!0,n.receiveShadow=!0,n.material.shadowSide=dt,e.add(n),n.position.set(0,.025,.25);const t=new ht(new vt,new ft({linewidth:3,color:16711680,dashed:!0,dashSize:.03125,gapSize:.0078125}));return t.visible=!1,e.add(t),{ball:n,parabolaLine:t}}function Dt(e,n){const t={hadFirstThrow:!1,chasingBallState:0,currentChasingTarget:null,allowKickBall:!1,ballStartMoving:null,ballThrowingTime:null,predictParabolaCurve:null,throwParabolaCurve:null,moving:null};function a(m,r){if(t.throwParabolaCurve){(t.ballStartMoving===null||t.ballThrowingTime===null)&&(t.ballThrowingTime=t.ballStartMoving=r);const o=r-t.ballThrowingTime,i=t.throwParabolaCurve.getPosition(o/1e3);if(n.ball.position.copy(i),r-t.ballStartMoving>250&&e.position.distanceTo(n.ball.position)>.1&&t.chasingBallState===0&&(t.chasingBallState=1),i.y<.025){n.ball.position.y=.025;const u=new l().copy(n.ball.position),g=new l().copy(t.throwParabolaCurve.getTangent(0));g.multiply(new l(.75,.5,.75)),g.x>.0078125||g.x<-.0078125||g.z>.0078125||g.z<-.0078125?(t.ballThrowingTime=r,t.throwParabolaCurve=E(u,g,Y)):S.state===0&&(t.ballStartMoving=null,t.throwParabolaCurve=null)}}if(t.hadFirstThrow){const o=new l().copy(n.ball.position).setY(e.position.y);e.lookAt(o);const i=n.ball.position.distanceTo(e.position),g=new l().copy(o).setY(0).length();if((!t.throwParabolaCurve||t.chasingBallState)&&!t.moving){const s=new l().copy(n.ball.position).setY(e.position.y);let w=null;switch(t.chasingBallState){case 0:{i>.1?t.chasingBallState=1:Math.random()<.0025&&!t.predictParabolaCurve&&(t.allowKickBall=!0);break}case 1:{if(!t.currentChasingTarget){const v=new l(0,1,0),p=new l().copy(s).setY(0),d=new l().crossVectors(v,p).normalize().multiplyScalar(.085),y=new l().copy(s).sub(d),C=new l().copy(s).add(d),f=new l().copy(s).addScaledVector(p.normalize(),.085),T=y.distanceTo(e.position),h=C.distanceTo(e.position),b=f.distanceTo(e.position);switch(Math.min(T,h,b)){case b:t.currentChasingTarget=f;break;case T:t.currentChasingTarget=y;break;case h:t.currentChasingTarget=C;break}}new l().subVectors(t.currentChasingTarget,e.position).length()<.01?(t.currentChasingTarget=null,t.chasingBallState=2):w=t.currentChasingTarget;break}case 2:if(i>.1)t.chasingBallState=1;else{const p=new l().copy(s).setY(0).normalize().multiplyScalar(.085),d=new l().copy(s).add(p);d.distanceTo(e.position)>.01&&(w=d),t.chasingBallState=0}}if(w){w.setY(0);const v=new l().subVectors(w,e.position),p=v.length();if(v.normalize().multiplyScalar(p/Math.ceil(p/.25)),t.moving=Et(e,e.position.clone(),e.position.clone().add(v)),t.moving){const d=t.moving.animation;F(d),t.moving.promise.then(()=>{t.moving=null,k(d)})}}}if(t.allowKickBall&&!t.predictParabolaCurve&&i<.1&&g>.5){const s=new l().subVectors(n.ball.position,e.position).setY(0).normalize();s.setY(.25),s.applyAxisAngle(new l(0,1,0),(Math.random()-.5)*Math.PI/8);const w=E(n.ball.position.clone(),s,Y);t.throwParabolaCurve=w,t.ballThrowingTime=r,t.allowKickBall=!1}}}function c(){t.hadFirstThrow=!1,t.chasingBallState=0,t.currentChasingTarget=null,t.allowKickBall=!1,t.ballStartMoving=null,t.ballThrowingTime=null,t.predictParabolaCurve=null,t.throwParabolaCurve=null,t.moving?.animation&&k(t.moving.animation),t.moving=null}return{animation:a,animationState:t,reset:c}}function Et(e,n,t,a=1.75){const c=Lt(n,t,Y,a,"high");if(!c)return null;const{promise:m,resolve:r}=Promise.withResolvers(),o=250,i=c.duration*1e3,u=200,s=c.getTangent(0).length(),p=c.getTangent(c.duration).length()/s;let d=!1;const y=.25;return{animation(C,f){let T=1;if(f<o){const h=f/o,b=h*h;T=1+y*.5*(3*b-2*h+Math.sqrt(8)*(b-h))}else if(f<o+i){const h=(f-o)/1e3,b=c.getTangent(h).length();T=1+y*(1-b/s),e.position.copy(c.getPosition(h))}else if(f<o+i+u){const h=(f-o-i)/u,b=h*h;T=1+y*p*(2*b-3*h+1+Math.sqrt(3)*(b-h)),d||(e.position.copy(c.getPosition(c.duration)),e.position.y=0,d=!0)}else r(),e.scale.y=B,e.scale.x=e.scale.z=B;e.scale.y=B*T,e.scale.x=e.scale.z=B/Math.sqrt(T)},promise:m}}let Z=null;function J(){Z?.()}const Yt=function(e){function n(c){if(!P)return;const m=P.camera,r=P.controls,o=m.getWorldDirection(new l).setY(0).normalize(),i=.3;m.position.addScaledVector(o,i*c/1e3),r.target.addScaledVector(o,i*c/1e3)}function t(){F(n)}function a(){k(n)}return e.addEventListener("pointerdown",t),e.addEventListener("pointerup",a),{destroy(){e.removeEventListener("pointerdown",t),e.removeEventListener("pointerup",a),k(n)}}},Ft=function(e){function n(c){if(!P)return;const m=P.camera,r=P.controls,o=m.getWorldDirection(new l).setY(0).normalize(),i=-.3;m.position.addScaledVector(o,i*c/1e3),r.target.addScaledVector(o,i*c/1e3)}function t(){F(n)}function a(){k(n)}return e.addEventListener("pointerdown",t),e.addEventListener("pointerup",a),{destroy(){e.removeEventListener("pointerdown",t),e.removeEventListener("pointerup",a),k(n)}}};var Gt=()=>(J(),history.back()),Mt=H('<div class="container svelte-1h15yrr"><canvas class="svelte-1h15yrr"></canvas> <button type="button" class="button left svelte-1h15yrr"><img alt="返回" draggable="false" class="svelte-1h15yrr"/> <span class="label svelte-1h15yrr">返回</span></button> <button type="button" class="button center-left svelte-1h15yrr"><img alt="前進" draggable="false" class="svelte-1h15yrr"/> <span class="label svelte-1h15yrr">前進</span></button> <button type="button" class="button center-right svelte-1h15yrr"><img alt="後退" draggable="false" class="svelte-1h15yrr"/> <span class="label svelte-1h15yrr">後退</span></button> <button type="button" class="button right svelte-1h15yrr"><img alt="重置" draggable="false" class="svelte-1h15yrr"/> <span class="label svelte-1h15yrr">重置</span></button></div>');function Rt(e,n){N(n,!1),At(),wt();var t=Mt(),a=x(_(t),2);a.__click=[Gt];var c=_(a),m=x(a,2),r=_(m);R(m,s=>Yt?.(s));var o=x(m,2),i=_(o);bt(i,"",{},{transform:"scaleX(-1)"}),R(o,s=>Ft?.(s));var u=x(o,2);u.__click=function(...s){J?.apply(this,s)};var g=_(u);R(t,s=>Vt?.(s)),yt(()=>{V(c,"src",A.backToGame.src),V(r,"src",A.move.src),V(i,"src",A.move.src),V(g,"src",A.reset.src)}),U(e,t),Q()}St(["click"]);function It(){const e=nt(X.throwingBallGame);Ct(e,"/game/throwing-ball")}const Ut=Object.freeze(Object.defineProperty({__proto__:null,default:Rt,gotoThrowingBall:It},Symbol.toStringTag,{value:"Module"}));export{Ct as a,It as g,Ut as i};
