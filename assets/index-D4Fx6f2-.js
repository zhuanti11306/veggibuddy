import{C as xe,p as je,K as Z,L as ye,I as ze,f as W,x as Me,o as Q,g as p,M as w,s as x,t as Se,i as _e,j as S,k as H,l as Pe,N as ke,h as n,O as Ae,c as ee}from"./index-CiVeqNK5.js";import{e as Ce,ay as Fe,G as Te,C as ae,r as Be,t as te,X as Oe,v as ie,w as re,M as L,i as He,T as $e,ap as We,B as y,V as z,m as Le,n as Ge,o as Xe,s as oe}from"./GLTFLoader-CQaeW04e.js";import{s as _}from"./class-CNRfvg9s.js";import{b as Re}from"./input-CY0t1r-S.js";import{r as G,c as h,g as ce,h as le,a as X,t as Ve,f as Ye,H as Ee,o as Ie,e as ue,l as De,p as Ne,q as Ue,s as qe,u as Je,d as A,n as Ke}from"./notice-2uxKH9Qy.js";let C,c,g;const s={object:new Te,size:{x:0,y:0},visible:!1,box:new y};async function Ze(){await Qe(),G()}async function Qe(){const t=await lt(Ge);s.object.add(t);const o=ut(s.object);s.size={x:o.size.x,y:o.size.y,z:o.size.z},s.box=o.box,s.object.scale.setScalar(.03),s.object.lookAt(h.position);const e=new z(0,0,1);s.object.rotateOnAxis(e,-Math.PI/2),st(),X(s.object),s.object.traverse(a=>{a instanceof L&&(a.material.depthTest=!0,a.material.depthWrite=!0,a.renderOrder=1)}),console.log("角色 GLB 載入完成")}function et(t,o){C=t||C;const e=new Be(C);e.minFilter=te,e.magFilter=te,e.format=Oe,e.needsUpdate=!0;const a=1,i=o.y/o.x,r=new ie(a,i),l=new re({map:e});c=new L(r,l),c.position.x=0,c.position.y=0,c.renderOrder=1;let f=h;const d=He.degToRad(f.fov),b=i/2/Math.tan(d/2);return c.position.z=1-b*1.01,le(new ae().setRGB(0,0,0)),X(c),c}function tt(t){g&&g.removeFromParent();const o=new $e().load(`data:image/png;base64,${t}`),e=new We(C);e.needsUpdate=!0;const a=new y().setFromObject(c),i=new z;a.getSize(i);const r=new ie(i.x,i.y),l=new re({map:e,alphaMap:o,depthWrite:!0,transparent:!0});return g=new L(r,l),Ve(g,c,.8),g.renderOrder=0,X(g),g}function ot(){if(!c)return;const t=new y().setFromObject(c),o=t.max.x-t.min.x,e=t.max.y-t.min.y;return{w:o,h:e}}function st(){const t=window.innerWidth*.3,o=window.innerHeight*.3,e=ce(t,o,{zPlane:.3});e.z=.3,s.object.position.copy(e),s.object.visible=!0}function nt(t,o){if(!c||!s.object)return;const e=new y().setFromObject(c),a=new z;e.getSize(a);const i=a.x,r=a.y,l=t/1920,f=o/1080,d=(l-.5)*i,m=(.5-f)*r;s.object.position.set(d,m,c.position.z+.05),s.object.lookAt(h.position)}function at(){if(!s||!c)return;const t=new z(0,0,1);s.object.rotateOnAxis(t,Math.PI/2),s.object.scale.setScalar(.05),s.object.position.z=c.position.z+.2,s.object.lookAt(c.position);const e=new y().setFromObject(c),a=e.min.x+s.size.x/2,i=e.max.x-s.size.x/2,r=e.min.y+s.size.y/2,l=e.max.y-s.size.y/2,f=Math.random()*(i-a)+a,d=Math.random()*(l-r)+r;return s.object.position.x=f,s.object.position.y=d,G(),()=>{const m=Math.random()*(i-a)+a,b=Math.random()*(l-r)+r;s.object.position.x=m,s.object.position.y=b,Math.random()>.8?s.object.lookAt(h.position):s.object.lookAt(c.position)}}function it(){let t=.001,o=0,e=.01;return s.object.visible=!0,s.object.scale.setScalar(.03),()=>{Math.random()>.5&&(Math.abs(o)<e?(s.object.position.x-=t,o+=t):(t*=-1,o=0))}}const se=new Fe,$=new Ce;function rt(t,o){$.x=t/window.innerWidth*2-1,$.y=-(o/window.innerHeight)*2+1,se.setFromCamera($,h);const e=se.intersectObject(s.object,!0);return e.length>0?(console.log("擊中角色！",e[0]),!0):!1}function ct(){if(!s)return;g.removeFromParent(),c.removeFromParent();const t=ce(window.innerWidth*.5,window.innerHeight*.5,{zPlane:.5});s.object.position.copy(t),s.object.lookAt(h.position),s.visible=!0;const o=s.object.scale.x;le(new ae(16775620));let e=0,a=1;return()=>{e+=5e-4*a,(e>.01||e<=0)&&(a*=-1),s.object.scale.setScalar(o+e)}}function lt(t){const o=new Le;return new Promise((e,a)=>{o.load(t,i=>e(i.scene),void 0,i=>a(i))})}function ut(t){let o=new y().setFromObject(t),e=new z;return o.getSize(e),{box:o,size:e}}async function fe(){try{await Ye(Ee),await Ze(),await Ie(),console.log(`[ThreeJS][Game-Throw] Camera position: ${h.position.toArray()}, controls active`)}catch(t){const o=t instanceof Error?t.message:String(t);console.error("初始化失敗:",t),window.alert(`應用程式啟動失敗！
錯誤訊息: ${o}`);return}}async function ft(){let t=De();if(t){let o=et(t.img,{x:t.width,y:t.height}),e=Ne(o);G();let a=at(),i=Ue(a,[800,1500]),r=await dt(t.img);if(r.hidingPoint){e&&e(),i(),A(()=>{});const l=r.mask;tt(l);const{x:f,y:d}=r.hidingPoint;nt(f,d);let m=it();return A(()=>{m()}),!0}else return i(),e&&e(),A(()=>{}),qe("偵測不到物體，已自動重置。"),de(),!1}else return console.log("拍攝失敗"),!1}async function dt(t){const o=await new Promise(a=>{t.toBlob(i=>a(i),"image/jpeg")}),e=new FormData;e.append("file",o,"frame.jpg");try{const i=await(await fetch("http://localhost:5000/detect",{method:"POST",body:e})).json();return console.log("收到回覆"),i}catch(a){console.error("偵測錯誤:",a)}}function mt(t){t-=50;let o=ot();if(!o)return;let e=h;const a=h.position.z,i=e.fov*Math.PI/180,r=a*Math.tan(i/2)*e.aspect,l=(o.w-r)/2,d=t/50;let m=new z(d*l,h.position.y,h.position.z);Je(m),console.log("slider")}function pt(t,o){if(rt(t,o)){let a=ct();return A(a),!0}return!1}function de(){ue().then(()=>{fe()})}function ne(){ue(),xe("/game")}var ht=W('<div id="loading-spinner" class="svelte-1g7iiw3"></div>'),bt=W('<div id="congratsText" class="svelte-1g7iiw3">Congratulation!</div>'),wt=W('<!> <canvas id="gameCanvas" class="svelte-1g7iiw3"></canvas> <div id="slider-container"><input id="slideControl" type="range" min="0" max="100" class="svelte-1g7iiw3"/></div> <button id="captureBtn" aria-label="Take a photo"></button> <button id="resetButton">↺</button> <button id="exitButton">×</button> <!> <div> </div>',1);function zt(t,o){je(o,!1);const e=()=>Ae(Ke,"$noticeEvent",a),[a,i]=ke();let r=w(!0),l=w(!1),f=w(!1),d=w(!1),m=w(!1),b=w(!1),v=w(!1),R=w(""),P=w(50);Xe(()=>(fe().then(()=>{n(r,!1),n(f,!0),n(m,!0),n(b,!0),n(l,!1),console.log("onMount")}),()=>{ne()}));function V(u){if(u.target.closest("#slideControl, #captureBtn, #resetButton, #exitButton"))return;const k="touches"in u?u.touches[0]:u;pt(k.clientX,k.clientY)&&(n(d,!0),n(l,!1),n(r,!1),n(f,!1),n(v,!1),n(m,!0),n(b,!0)),console.log("handlePress")}async function me(){let u=await ft();u&&(n(f,!1),n(l,!0),n(d,!1),n(r,!1),n(v,!1),n(m,!0),n(b,!0)),console.log(u)}function pe(){de(),n(l,!1),n(f,!0),n(d,!1),n(r,!1),n(v,!1),n(m,!0),n(b,!0)}function he(){ne(),n(l,!1),n(f,!1),n(d,!1),n(r,!1),n(v,!1),n(m,!1),n(b,!1)}Z(()=>p(P),()=>{mt?.(p(P))}),Z(()=>e(),()=>{e()?(n(R,e()),n(v,!0)):n(v,!1)}),ye(),ze();var Y=wt(),E=Me(Y);{var be=u=>{var j=ht();H(u,j)};Q(E,u=>{p(r)&&u(be)})}var M=x(E,2);oe(M,"width",innerWidth),oe(M,"height",innerHeight);var F=x(M,2);let I;var we=ee(F),T=x(F,2);let D;var B=x(T,2);let N;var O=x(B,2);let U;var q=x(O,2);{var ge=u=>{var j=bt();H(u,j)};Q(q,u=>{p(d)&&u(ge)})}var J=x(q,2),ve=ee(J);Se((u,j,k,K)=>{I=_(F,1,"svelte-1g7iiw3",null,I,u),D=_(T,1,"svelte-1g7iiw3",null,D,j),N=_(B,1,"svelte-1g7iiw3",null,N,k),U=_(O,1,"svelte-1g7iiw3",null,U,K),_(J,1,`notice ${p(v)?"show":""}`,"svelte-1g7iiw3"),_e(ve,p(R))},[()=>({visible:p(l)}),()=>({visible:p(f)}),()=>({visible:p(m)}),()=>({visible:p(b)})]),S("mousedown",M,V),S("touchstart",M,V),Re(we,()=>p(P),u=>n(P,u)),S("click",T,me),S("click",B,pe),S("click",O,he),H(t,Y),Pe(),i()}export{zt as default};
