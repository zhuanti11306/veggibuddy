import{q as B,h as x,A as j,b as C,K as D,l as y,B as N,n as X,M as z,j as T,w as U,a0 as Z,a1 as L,a2 as K,a3 as F,a4 as q,R as G,V as Q,a5 as J,Z as $,p as ee,i as te,C as O,u as ae,O as se,g as oe,d as ne,H as A}from"./vendor-BHUJVZvY.js";import{M as re,N as ce,Q as ie,p as I,y as V,B as Y,S as le,t as de,A as he,R as W,x as me,o as H}from"./settings.svelte-DG0GX0uq.js";import{o as S}from"./dialogs-Cklb8uX6.js";import"./firebase-Nwrn9kXS.js";var ue=x('<div><p> </p> <p class="hint svelte-alyajq">點擊空白位置以關閉</p></div>');function R(t,a){let e=B(a,"orientation",3,"landscape");var s=ue(),n=y(s),r=y(n);j(()=>{D(s,1,`message ${e()??""}`,"svelte-alyajq"),D(n,1,`content ${a.style??""}`,"svelte-alyajq"),N(r,a.message)}),C(t,s)}let u=null;const pe=1,ve=1,k=U(()=>I.isLegal?{id:I.type,assets:ie[I.type]}:null);let d=null;function ge(){z(()=>{if(!T(k))return;const t=T(k).id,a=T(k).assets;re(t).then(()=>{const e=u?.scene;if(!e)return;const s=a.model.object;s&&(e.add(s),s.position.set(-.2,.4,0),s.rotation.set(0,0,0),s.rotateY(-Math.PI/2),s.rotateX(-Math.PI/2),s.visible=!0),d?.model.object&&d!==a&&e.remove(d.model.object),d=a})})}let M=null;const p=[];async function fe(){if(!M)return console.warn("[WRN] Video canvas not initialized.");if(!u)return console.warn("[WRN] Scene not initialized.");p.length&&(u.scene.remove(...p),p.length=0);const{width:t,height:a}=M.canvas,{scene:e,camera:s}=u,n=M.context.getImageData(0,0,t,a),r=be(n,s);e.add(r),p.push(r);const{canvas:h}=M;h.toBlob(async o=>{if(o)try{const c=await de(he.imageObjectDetection,{file:o});if(c.hidingPoint&&d?.model.object){const i=ye(c.mask,r,n,s);e.add(i),p.push(i);const{x:l,y:m}=c.hidingPoint,v=we(r,l,m,h.width,h.height),w=r.position.y;d.model.object.position.set(v.x,w+.1,v.z),d.model.object.renderOrder=1,d.model.object.lookAt(s.position),je()}else S(R,{props:{message:"這裡好像沒有地方可以躲，換個地方拍拍看吧！",style:"failure"}}),e.remove(...p),p.length=0}catch(c){console.error("偵測發生錯誤:",c),S(R,{props:{message:"連線錯誤，請稍後再試",style:"failure"}})}},"image/jpeg")}let f=null,g=null;const b=X({});function be(t,a){f&&(f.geometry.dispose(),Array.isArray(f.material)?f.material.forEach(v=>v.dispose()):f.material.dispose(),u?.scene.remove(f));const e=new Z(t);e.minFilter=L,e.magFilter=L,e.colorSpace=K,e.needsUpdate=!0;const s=pe,n=t.height/t.width*s,r=new F(s,n);r.rotateX(-Math.PI/2);const h=new q({map:e}),o=new G(r,h);o.position.set(0,0,0);const c=a.fov*Math.PI/180,l=n/2/Math.tan(c/2),m=ve-l;return o.position.y=m,o.userData={width:s,height:n,distanceToCamera:l,y:m},o.renderOrder=0,f=o,o}function we(t,a,e,s,n){const r=t.userData.width,h=t.userData.height,o=a/s-.5,c=e/n-.5,i=o*r,l=c*h;return new Q(i,0,l)}function ye(t,a,e,s){g&&(g.geometry.dispose(),g.material.dispose(),g.removeFromParent());const r=new J().load(`data:image/png;base64,${t}`),h=a.material.map,o=a.userData,c=.5,i=o.y+c,m=(o.distanceToCamera-c)/o.distanceToCamera,v=o.width*m,w=o.height*m,_=new F(v,w);_.rotateX(-Math.PI/2);const P=new q({map:h,alphaMap:r,transparent:!0,opacity:1,alphaTest:.1});return g=new G(_,P),g.position.set(0,i,0),g.renderOrder=2,g}const Me=function(t){const a=t.querySelector("#pet");if(!a||!(a instanceof HTMLCanvasElement))throw new Error("Canvas element not found in container.");const e=t.querySelector("#video");if(!e||!(e instanceof HTMLCanvasElement))throw new Error("Video element not found in container.");M={canvas:e,context:e.getContext("2d")};const s=t.querySelector("video");if(!s||!(s instanceof HTMLVideoElement))throw new Error("Video element not found in container.");const n=u=ce(t,a,le.hideNSeekGame);let r=null;return Promise.all([T(k)?.assets.model.whenLoaded,_e(s,e)]).then(([o,c])=>{r=()=>{o.object.removeFromParent(),c()}}),new ResizeObserver(()=>{const{clientWidth:o,clientHeight:c}=t;e.width=o,e.height=c}).observe(t),{destroy(){n.dispose(),r?.()}}};function _e(t,a){let e=null;const s=1920,n=1080;a&&(a.width=s,a.height=n);const r=a?.getContext("2d");if(!r)throw new Error("Cannot get 2D context from canvas.");function h(){if(t.paused||t.ended||t.readyState<2||t.videoWidth===0)return;const{width:o,height:c}=a,{videoWidth:i,videoHeight:l}=t,m=Math.max(o/i,c/l),v=i*m,w=l*m,_=(o-v)/2,P=(c-w)/2;r.clearRect(0,0,o,c),r.drawImage(t,_,P,v,w)}return V(h),navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}},audio:!1}).then(o=>{t.srcObject=e=o,t.play()}).catch(o=>{console.error("Camera access denied or not supported:",o)}),()=>{Y(h),e&&(e.getTracks().forEach(o=>o.stop()),e=null)}}function je(){b.call?.();const t=new $,a=u.controls.domElement,e=s=>{if(!d?.model.object||!u)return;const n=a.getBoundingClientRect();t.x=(s.clientX-n.left)/n.width*2-1,t.y=-((s.clientY-n.top)/n.height)*2+1,W.setFromCamera(t,u.camera),W.intersectObject(d.model.object,!0).length>0&&Ce()};V(E),a.addEventListener("click",e),b.call=()=>{d?.model.object&&(d.model.object.position.set(-.2,.4,0),d.model.object.rotation.set(0,0,0),d.model.object.rotateY(-Math.PI/2),d.model.object.rotateX(-Math.PI/2)),u&&(u.scene.remove(...p),p.length=0),Y(E),a.removeEventListener("click",e),b.call=void 0}}function Ce(){b.call?.(),me("CHAT"),S(R,{props:{message:"恭喜找到寵物！獲得金幣！",style:"success"}}),u.scene.remove(...p),p.length=0}function E(t,a){if(!d?.model.object||!u)return;const e=d.model.object;e.rotation.z=(Math.sin(a/1e3)/3-.5)*Math.PI}var Te=()=>(b.call?.(),history.back()),ke=()=>b.call?.(),xe=x('<button type="button" class="button right svelte-r1w5lc"><img alt="取消" draggable="false" class="svelte-r1w5lc"/> <span class="label svelte-r1w5lc">取消</span></button>'),Pe=()=>fe(),Ae=x('<button type="button" class="button right svelte-r1w5lc"><img alt="拍攝" draggable="false" class="svelte-r1w5lc"/> <span class="label svelte-r1w5lc">拍攝</span></button>'),Ie=x('<div class="container svelte-r1w5lc"><video autoplay playsinline="" class="svelte-r1w5lc"></video> <canvas id="video" class="svelte-r1w5lc"></canvas> <canvas id="pet" class="svelte-r1w5lc"></canvas> <button type="button" class="button left svelte-r1w5lc"><img alt="返回" draggable="false" class="svelte-r1w5lc"/> <span class="label svelte-r1w5lc">返回</span></button> <!></div>',2);function Le(t,a){ee(a,!1),ge(),te();var e=Ie(),s=y(e);s.muted=!0;var n=O(s,6);n.__click=[Te];var r=y(n),h=O(n,2);{var o=i=>{var l=xe();l.__click=[ke];var m=y(l);j(()=>A(m,"src",H.reset.src)),C(i,l)},c=i=>{var l=Ae();l.__click=[Pe];var m=y(l);j(()=>A(m,"src",H.camera.src)),C(i,l)};ae(h,i=>{b.call?i(o):i(c,!1)})}se(e,i=>Me?.(i)),j(()=>A(r,"src",H.backToGame.src)),C(t,e),oe()}ne(["click"]);export{Le as default};
