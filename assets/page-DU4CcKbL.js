import{a as e,G as t,g as a,m as o,p as s,I as n,f as r,c as i,s as l,o as c,t as d,k as m,l as h,d as v}from"./index-B74hZ3uX.js";import{k as u,a5 as g,a6 as p,a8 as b,p as f,a9 as w,D as j,G as y,z as M,A as P,ad as C,ae as k,af as x,ag as E,ah as I,a0 as D,V as T,ai as O,_,ac as L,q as S,s as H,aj as X}from"./index-BruxziNw.js";let q=null;const{promise:z,resolve:A}=Promise.withResolvers(),F=o(()=>f.isLegal?{id:f.type,assets:b[f.type]}:null),{promise:R,resolve:V}=Promise.withResolvers();let G=null;let W=null;const Y=[];async function B(){if(!W)return;if(!q)return;Y.length&&(q.scene.remove(...Y),Y.length=0);const{width:e,height:t}=W.canvas,{scene:a,camera:o}=q,s=W.context.getImageData(0,0,e,t),n=function(e,t){U&&(U.geometry.dispose(),Array.isArray(U.material)?U.material.forEach(e=>e.dispose()):U.material.dispose(),q?.scene.remove(U));const a=new C(e);a.minFilter=k,a.magFilter=k,a.colorSpace=x,a.needsUpdate=!0;const o=1,s=e.height/e.width*o,n=new E(o,s);n.rotateX(-Math.PI/2);const r=new I({map:a}),i=new D(n,r);i.position.set(0,0,0);const l=t.fov*Math.PI/180,c=s/2/Math.tan(l/2),d=1-c;return i.position.y=d,i.userData={width:o,height:s,distanceToCamera:c,y:d},i.renderOrder=0,U=i,i}(s,o);a.add(n),Y.push(n);const{canvas:r}=W;r.toBlob(async e=>{if(e)try{const t=await M(P.imageObjectDetection,{file:e});if(t.hidingPoint&&G?.model.object){const e=function(e,t){N&&(N.geometry.dispose(),N.material.dispose(),N.removeFromParent());const a=(new O).load(`data:image/png;base64,${e}`),o=t.material.map,s=t.userData,n=.5,r=s.y+n,i=(s.distanceToCamera-n)/s.distanceToCamera,l=s.width*i,c=s.height*i,d=new E(l,c);d.rotateX(-Math.PI/2);const m=new I({map:o,alphaMap:a,transparent:!0,opacity:1,alphaTest:.1});return N=new D(d,m),N.position.set(0,r,0),N.renderOrder=2,N}(t.mask,n);a.add(e),Y.push(e);const{x:s,y:i}=t.hidingPoint,l=function(e,t,a,o,s){const n=e.userData.width,r=e.userData.height,i=t/o-.5,l=a/s-.5;return new T(i*n,0,l*r)}(n,s,i,r.width,r.height),c=n.position.y;G.model.object.position.set(l.x,c,l.z),G.model.object.renderOrder=1,G.model.object.lookAt(o.position),function(){$.call?.();const e=new _,t=q.controls.domElement,a=a=>{if(!G?.model.object||!q)return;const o=t.getBoundingClientRect();e.x=(a.clientX-o.left)/o.width*2-1,e.y=-(a.clientY-o.top)/o.height*2+1,L.setFromCamera(e,q.camera);L.intersectObject(G.model.object,!0).length>0&&($.call?.(),alert("恭喜找到寵物！"),q.scene.remove(...Y),Y.length=0)};j(K),t.addEventListener("click",a),$.call=()=>{G?.model.object&&(G.model.object.position.set(-.2,.4,0),G.model.object.rotation.set(0,0,0),G.model.object.rotateY(-Math.PI/2),G.model.object.rotateX(-Math.PI/2)),q&&(q.scene.remove(...Y),Y.length=0),y(K),t.removeEventListener("click",a),$.call=void 0}}()}else alert("這裡好像沒有地方可以躲，換個地方拍拍看吧！"),a.remove(...Y),Y.length=0}catch(t){alert("連線錯誤，請稍後再試")}},"image/jpeg")}let U=null,N=null;const $=e({});function J(e,t){let a=null;const o=t?.getContext("2d");if(!o)throw new Error("Cannot get 2D context from canvas.");function s(){if(e.paused||e.ended)return;if(e.readyState<2||0===e.videoWidth)return;const{width:a,height:s}=t;if(!a||!s)return;const{videoHeight:n,videoWidth:r}=e,i=Math.max(a/r,s/n);o.save(),o.scale(i,i),o.drawImage(e,0,0,r,n),o.restore()}return j(s),navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1}).then(t=>{e.srcObject=a=t,e.play()}),()=>{y(s),a&&(a.getTracks().forEach(e=>e.stop()),a=null)}}function K(e,t){if(!G?.model.object)return;if(!q)return;G.model.object.rotation.z=(Math.sin(t/1e3)/3-.5)*Math.PI}var Q=()=>history.back(),Z=()=>$.call?.(),ee=r('<button type="button" class="button right svelte-r1w5lc"><img alt="取消" draggable="false" class="svelte-r1w5lc"/> <span class="label svelte-r1w5lc">取消</span></button>'),te=()=>B(),ae=r('<button type="button" class="button right svelte-r1w5lc"><img alt="拍攝" draggable="false" class="svelte-r1w5lc"/> <span class="label svelte-r1w5lc">拍攝</span></button>'),oe=r('<div class="container svelte-r1w5lc"><video autoplay playsinline="" class="svelte-r1w5lc"></video> <canvas id="video" class="svelte-r1w5lc"></canvas> <canvas id="pet" class="svelte-r1w5lc"></canvas> <button type="button" class="button left svelte-r1w5lc"><img alt="返回" draggable="false" class="svelte-r1w5lc"/> <span class="label svelte-r1w5lc">返回</span></button> <!></div>',2);function se(e,o){s(o,!1),t(()=>{if(!a(F))return void u();const e=a(F).id;Promise.all([g(e),z]).then(([e,{scene:t}])=>{e.model.object&&(t.add(e.model.object),e.model.object.position.set(-.2,.4,0),e.model.object.rotation.set(0,0,0),e.model.object.rotateY(-Math.PI/2),e.model.object.rotateX(-Math.PI/2),V(e.model.object)),G?.model.object&&t.remove(G.model.object),G=e})}),n();var r=oe(),v=i(r);v.muted=!0;var b=l(v,6);b.__click=[Q];var f=i(b),j=l(b,2),y=e=>{var t=ee();t.__click=[Z];var a=i(t);d(()=>H(a,"src",X.veggieCam.src)),m(e,t)},M=e=>{var t=ae();t.__click=[te];var a=i(t);d(()=>H(a,"src",X.veggieCam.src)),m(e,t)};c(j,e=>{$.call?e(y):e(M,!1)}),S(r,e=>function(e){const t=e.querySelector("#pet");if(!(t&&t instanceof HTMLCanvasElement))throw new Error("Canvas element not found in container.");const a=e.querySelector("#video");if(!(a&&a instanceof HTMLCanvasElement))throw new Error("Video element not found in container.");W={canvas:a,context:a.getContext("2d")};const o=e.querySelector("video");if(!(o&&o instanceof HTMLVideoElement))throw new Error("Video element not found in container.");const s=q=p(e,t,w.hideNSeekGame);A(s);let n=null;return Promise.all([R,J(o,a)]).then(([e,t])=>{n=()=>{t()}}),new ResizeObserver(()=>{const{clientWidth:t,clientHeight:o}=e;a.width=t,a.height=o}).observe(e),{destroy(){s.dispose(),n?.()}}}?.(e)),d(()=>H(f,"src",X.veggieCam.src)),m(e,r),h()}v(["click"]);export{se as default};
