import{a as ot,p as dt,I as ut,f as D,s as g,c as v,o as F,t as et,i as st,k as E,l as ht,w as T,x as G,d as ft}from"./index-CiVeqNK5.js";import{w as vt,A as Et,E as pt,x as at,y as mt,P as gt,z as bt,B as wt,C as Rt,n as yt,c as _t,v as kt}from"./index-DfbJhxeW.js";import{s as Ct}from"./GLTFLoader-CQaeW04e.js";class b extends EventTarget{static audioContext;static communications=new Map;readyState="loading";socket;token;currentAudio;isResponding=!1;autoPlay=!0;constructor(t){super(),this.initializeConnection(t)}async initializeConnection(t){try{const e=await Promise.resolve(t);this.token=e,b.communications.has(e)?this.socket=b.communications.get(e):(this.socket=new WebSocket(`${pt.API.WS_BASE_URL}/response/${e}`),b.communications.set(e,this.socket)),this.socket?.readyState===WebSocket.OPEN?this.setupSocketHandlers():this.socket?.addEventListener("open",()=>this.setupSocketHandlers())}catch(e){this.readyState="error",this.dispatchEvent(new CustomEvent("error",{detail:e}))}}setupSocketHandlers(){this.socket&&(this.readyState="ready",this.dispatchEvent(new CustomEvent("ready")),this.socket.addEventListener("message",async t=>{const e=JSON.parse(t.data);if(this.dispatchEvent(new CustomEvent("message",{detail:e})),this.dispatchEvent(new CustomEvent("received",{detail:e.emotion})),!this.autoPlay)return;const a=await this.playAudio(e.audio);a&&(await a.promise,this.dispatchEvent(new CustomEvent("played",{detail:e.emotion})))}),this.socket.addEventListener("close",()=>{this.readyState="error"}),this.socket.addEventListener("error",t=>{this.readyState="error"}))}async playAudio(t){try{const e=atob(t),a=new Uint8Array(e.length);for(let o=0;o<e.length;o++)a[o]=e.charCodeAt(o);const n=this.getAudioContext(),r=await n.decodeAudioData(a.buffer);return this.currentAudio?.stop(),this.currentAudio=n.createBufferSource(),this.currentAudio.buffer=r,this.currentAudio.connect(n.destination),{promise:new Promise(o=>{this.currentAudio.onended=()=>{this.currentAudio=void 0,o()},this.currentAudio.start(0)})}}catch{}finally{this.isResponding=!1}}getAudioContext(){return b.audioContext||(b.audioContext=new AudioContext),b.audioContext}canSendMessage(){return!(!this.socket||this.readyState!=="ready"||this.isResponding)}async waitForReady(){return console.log(this),this.readyState==="ready"&&!this.isResponding?this:new Promise((t,e)=>{const a=()=>{this.readyState==="ready"&&!this.isResponding&&(this.removeEventListener("ready",a),this.removeEventListener("received",a),t(this))},n=r=>{this.removeEventListener("ready",a),this.removeEventListener("received",a),this.removeEventListener("error",n),e(r.detail)};this.addEventListener("ready",a),this.addEventListener("received",a),this.addEventListener("error",n)})}sendAudio(t){return this.canSendMessage()?(this.socket.send(t),this.isResponding=!0,!0):!1}async sendAudioAndWait(t){if(await this.waitForReady(),!this.sendAudio(t))throw new Error("無法發送音訊");const e=new Promise(r=>{this.addEventListener("received",l=>r(l.detail),{once:!0})}),a=this.autoPlay?new Promise(r=>{this.addEventListener("played",()=>r(),{once:!0})}):Promise.resolve();return{emotion:await e,played:a}}close(){this.socket&&this.token&&(this.socket.close(),b.communications.delete(this.token),this.socket=void 0),this.currentAudio?.stop(),this.currentAudio=void 0}}class At{static instance;static getConversation(){if(!this.instance){const t=vt(Et.chatGetToken).then(e=>e.session_token);this.instance=new b(t)}return this.instance}static closeConversation(){this.instance&&(this.instance.close(),this.instance=void 0)}}var c;(function(s){s.LOAD="LOAD",s.EXEC="EXEC",s.FFPROBE="FFPROBE",s.WRITE_FILE="WRITE_FILE",s.READ_FILE="READ_FILE",s.DELETE_FILE="DELETE_FILE",s.RENAME="RENAME",s.CREATE_DIR="CREATE_DIR",s.LIST_DIR="LIST_DIR",s.DELETE_DIR="DELETE_DIR",s.ERROR="ERROR",s.DOWNLOAD="DOWNLOAD",s.PROGRESS="PROGRESS",s.LOG="LOG",s.MOUNT="MOUNT",s.UNMOUNT="UNMOUNT"})(c||(c={}));const Dt=(()=>{let s=0;return()=>s++})(),Lt=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),St=new Error("called FFmpeg.terminate()");class Ot{#e=null;#a={};#s={};#i=[];#n=[];loaded=!1;#o=()=>{this.#e&&(this.#e.onmessage=({data:{id:t,type:e,data:a}})=>{switch(e){case c.LOAD:this.loaded=!0,this.#a[t](a);break;case c.MOUNT:case c.UNMOUNT:case c.EXEC:case c.FFPROBE:case c.WRITE_FILE:case c.READ_FILE:case c.DELETE_FILE:case c.RENAME:case c.CREATE_DIR:case c.LIST_DIR:case c.DELETE_DIR:this.#a[t](a);break;case c.LOG:this.#i.forEach(n=>n(a));break;case c.PROGRESS:this.#n.forEach(n=>n(a));break;case c.ERROR:this.#s[t](a);break}delete this.#a[t],delete this.#s[t]})};#t=({type:t,data:e},a=[],n)=>this.#e?new Promise((r,l)=>{const o=Dt();this.#e&&this.#e.postMessage({id:o,type:t,data:e},a),this.#a[o]=r,this.#s[o]=l,n?.addEventListener("abort",()=>{l(new DOMException(`Message # ${o} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(Lt);on(t,e){t==="log"?this.#i.push(e):t==="progress"&&this.#n.push(e)}off(t,e){t==="log"?this.#i=this.#i.filter(a=>a!==e):t==="progress"&&(this.#n=this.#n.filter(a=>a!==e))}load=({classWorkerURL:t,...e}={},{signal:a}={})=>(this.#e||(this.#e=t?new Worker(new URL(t,import.meta.url),{type:"module"}):new Worker(new URL("/assets/worker-BAOIWoxA.js",import.meta.url),{type:"module"}),this.#o()),this.#t({type:c.LOAD,data:e},void 0,a));exec=(t,e=-1,{signal:a}={})=>this.#t({type:c.EXEC,data:{args:t,timeout:e}},void 0,a);ffprobe=(t,e=-1,{signal:a}={})=>this.#t({type:c.FFPROBE,data:{args:t,timeout:e}},void 0,a);terminate=()=>{const t=Object.keys(this.#s);for(const e of t)this.#s[e](St),delete this.#s[e],delete this.#a[e];this.#e&&(this.#e.terminate(),this.#e=null,this.loaded=!1)};writeFile=(t,e,{signal:a}={})=>{const n=[];return e instanceof Uint8Array&&n.push(e.buffer),this.#t({type:c.WRITE_FILE,data:{path:t,data:e}},n,a)};mount=(t,e,a)=>{const n=[];return this.#t({type:c.MOUNT,data:{fsType:t,options:e,mountPoint:a}},n)};unmount=t=>{const e=[];return this.#t({type:c.UNMOUNT,data:{mountPoint:t}},e)};readFile=(t,e="binary",{signal:a}={})=>this.#t({type:c.READ_FILE,data:{path:t,encoding:e}},void 0,a);deleteFile=(t,{signal:e}={})=>this.#t({type:c.DELETE_FILE,data:{path:t}},void 0,e);rename=(t,e,{signal:a}={})=>this.#t({type:c.RENAME,data:{oldPath:t,newPath:e}},void 0,a);createDir=(t,{signal:e}={})=>this.#t({type:c.CREATE_DIR,data:{path:t}},void 0,e);listDir=(t,{signal:e}={})=>this.#t({type:c.LIST_DIR,data:{path:t}},void 0,e);deleteDir=(t,{signal:e}={})=>this.#t({type:c.DELETE_DIR,data:{path:t}},void 0,e)}var it;(function(s){s.MEMFS="MEMFS",s.NODEFS="NODEFS",s.NODERAWFS="NODERAWFS",s.IDBFS="IDBFS",s.WORKERFS="WORKERFS",s.PROXYFS="PROXYFS"})(it||(it={}));const It=new Error("failed to get response body reader"),Pt=new Error("failed to complete download"),Ft="Content-Length",xt=async(s,t)=>{const e=await fetch(s);let a;try{const n=parseInt(e.headers.get(Ft)||"-1"),r=e.body?.getReader();if(!r)throw It;const l=[];let o=0;for(;;){const{done:d,value:m}=await r.read(),h=m?m.length:0;if(d){if(n!=-1&&n!==o)throw Pt;t&&t({url:s,total:n,received:o,delta:h,done:d});break}l.push(m),o+=h,t&&t({url:s,total:n,received:o,delta:h,done:d})}const u=new Uint8Array(o);let p=0;for(const d of l)u.set(d,p),p+=d.length;a=u.buffer}catch(n){console.log("failed to send download progress event: ",n),a=await e.arrayBuffer()}return a},nt=async(s,t,e=!1,a)=>{const n=e?await xt(s,a):await(await fetch(s)).arrayBuffer(),r=new Blob([n],{type:t});return URL.createObjectURL(r)},jt="/assets/ffmpeg-core-CI9Irx9p.js",Bt="/assets/ffmpeg-core-CgUfceKH.wasm",w=new Ot;w.on("log",s=>{console.log(`[DBG] (FFMPEG) [${s.type}] ${s.message}`)});const Mt={coreURL:await nt(jt,"text/javascript"),wasmURL:await nt(Bt,"application/wasm")};async function Wt(){return w.loaded?!0:w.load(Mt).then(()=>!0).catch(s=>(console.error("[ERR] (FFMPEG) Failed to load FFmpeg:",s),!1))}async function Nt(s){const t=await Promise.allSettled(s.map(e=>w.deleteFile(e)));for(const e of t)e.status==="rejected"&&console.warn("[WRN] (FFMPEG) Failed to delete file:",e.reason)}const q="input.webm",J="output.mp3";async function Ut(s,t){if(w.loaded===!1)return console.error("[ERR] (FFMPEG) FFmpeg is not loaded"),null;await w.writeFile(q,new Uint8Array(await s.arrayBuffer()),{signal:t}),await w.exec(["-i",q,J],-1,{signal:t});const e=await w.readFile(J,"binary",{signal:t});return await Tt(),e instanceof Uint8Array?e:(console.error("[ERR] (FFMPEG) Failed to convert WebM to MP3: output is not Uint8Array"),null)}async function Tt(){return Nt([q,J])}class Z{static defaultOptions={clearWhenDraw:!0,barColor:"black",barWidth:3,barGap:1,fftsize:2048,durationSec:.5};canvas;context;options;stream=null;audioContext=null;analyser=null;dataChunk=null;waveformBuffer=null;bufferHead=0;constructor(t,e,a){if(this.canvas=t,this.context=e,e.canvas!==t)throw new Error("Canvas and context do not match.");this.options={...Z.defaultOptions,...a}}setStream(t){this.stream=t,this.audioContext=new AudioContext;const e=this.audioContext.createMediaStreamSource(this.stream);this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.options.fftsize,this.dataChunk=new Float32Array(this.analyser.frequencyBinCount);const a=this.audioContext.sampleRate,n=this.options.durationSec??.5,r=Math.ceil(a*n);this.waveformBuffer=new Float32Array(r),this.bufferHead=0,e.connect(this.analyser)}setFFTSize(t){this.options.fftsize=t,this.analyser&&(this.analyser.fftSize=t,this.dataChunk&&(this.dataChunk=new Float32Array(this.analyser.frequencyBinCount)))}setDuration(t){if(this.options.durationSec=t,this.audioContext&&this.waveformBuffer){const e=this.audioContext.sampleRate,a=Math.ceil(e*t);this.waveformBuffer=new Float32Array(a),this.bufferHead=0}}toggleClearWhenDraw(t){this.options.clearWhenDraw=t??!this.options.clearWhenDraw}setBarColor(t){this.options.barColor=t}setBarWidth(t){this.options.barWidth=t}setBarGap(t){this.options.barGap=t}draw(){const t=this.context,e=this.canvas.width,a=this.canvas.height;(this.options.clearWhenDraw??!0)&&t.clearRect(0,0,e,a),t.save();const n=this.options.barWidth+this.options.barGap,r=Math.floor(e/n);!this.analyser||!this.dataChunk||!this.waveformBuffer?this.drawWaiting(r):this.drawWaveform(r),t.restore()}destroy(){if(this.stream){for(const t of this.stream.getTracks())this.stream.removeTrack(t);this.stream=null}this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.analyser&&(this.analyser.disconnect(),this.analyser=null)}waitingLineOffset=0;drawWaiting(t){const e=[];this.waitingLineOffset=(this.waitingLineOffset+.25)%t;for(let a=0;a<t;a++){const n=(a+this.waitingLineOffset)%t-t/2,r=1.05**-(n*n)*.5*Math.sin(n/5+a/3),l=this.canvas.height/2*(1-r),o=this.canvas.height/2;e.push([l,o])}this.drawLines(e)}drawWaveform(t){if(!this.analyser||!this.dataChunk||!this.waveformBuffer)return;this.canvas.width;const e=this.canvas.height;this.analyser.getFloatTimeDomainData(this.dataChunk);for(let l=0;l<this.dataChunk.length;l++)this.waveformBuffer[this.bufferHead]=this.dataChunk[l],this.bufferHead=(this.bufferHead+1)%this.waveformBuffer.length;const a=this.waveformBuffer.length,n=Math.floor(a/t),r=[];for(let l=0;l<t;l++){const o=l*n;let u=0;for(let h=0;h<n;h++){const z=(this.bufferHead+o+h)%a,x=Math.abs(this.waveformBuffer[z]);x>u&&(u=x)}const p=Math.max(u,.0078625)*e,d=e/2-p/2,m=e/2+p/2;r.push([d,m])}this.drawLines(r)}drawLines(t){const e=this.context,a=this.canvas.width;e.lineWidth=this.options.barWidth,e.strokeStyle=this.options.barColor,e.lineCap="round";const n=this.options.barWidth+this.options.barGap,r=Math.floor(a/n),l=(a-r*n)/2+this.options.barGap;for(let o=0;o<t.length;o++){const u=t[o][0],p=t[o][1],d=o*n+l;e.beginPath(),e.moveTo(d,u),e.lineTo(d,p),e.stroke()}}}var Gt=(s=>(s[s.Success=0]="Success",s[s.Ungranted=1]="Ungranted",s[s.Failed=2]="Failed",s))(Gt||{});const R=ot({seconds:-1,interval:null,get formatted(){if(this.seconds<0)return"-- : --";const s=Math.floor(this.seconds/60).toString().padStart(2,"0"),t=(this.seconds%60).toString().padStart(2,"0");return`${s} : ${t}`},start(){this.resume(),this.seconds=0},stop(){this.pause(),this.seconds=-1},resume(){this.interval||(this.interval=setInterval(()=>this.seconds+=1,1e3))},pause(){this.interval&&(clearInterval(this.interval),this.interval=null)}}),$=[];var Q=(s=>(s.Voice="voice",s.Sound="sound",s))(Q||{});const i=ot({state:4,initializing:!1,recorderInstance:null,READY:0,RECORDING:1,PAUSED:2,PROCESSING:3,UNGRANTED:4,FAILED:5,get instance(){return this.recorderInstance},set instance(s){if(!s){this.recorderInstance&&(this.recorderInstance.onstop=null,this.recorderInstance.ondataavailable=null,this.recorderInstance.stop());return}$.length=0,this.recorderInstance=s,s.ondataavailable=t=>{$.push(t.data)}},get blob(){return new Blob($,{type:"audio/webm"})},startRecording:zt,stopRecording:Xt,pauseRecording:Yt,resumeRecording:Vt,initialize:rt,mode:"voice",toggleMode(){switch(this.mode){case"voice":this.mode="sound",y&&(y.autoPlay=!1);break;case"sound":this.mode="voice",y&&(y.autoPlay=!0);break}}});let H=null,y=null,_=null;async function rt(){if(i.state!==4||i.initializing)return;if(!("mediaDevices"in navigator)){console.warn("[WRN] (Media) Media Devices API not supported."),i.state=5;return}const s=navigator.mediaDevices.getUserMedia({audio:!0}).then(o=>({stream:o,result:0})).catch(o=>({error:o,result:1})),t=At.getConversation().waitForReady().then(o=>({conversation:o,result:0})).catch(o=>({error:o,result:2})),e=w.loaded?Promise.resolve({result:0}):Wt().then(o=>({result:o?0:2})).catch(o=>({error:o,result:2}));i.initializing=!0;const a=await Promise.all([s,t,e]),[n,r]=a;switch(console.log("[DBG] (Media) Initialization results:",a),a.reduce((o,u)=>Math.max(u.result,o),0)){case 0:H=n.stream,Ht(r.conversation),i.state=0,_?.setStream(H);break;case 1:i.state=4;break;case 2:i.state=5;break}i.initializing=!1}function Ht(s){y=s}function zt(){i.state===0&&H&&(i.instance=new MediaRecorder(H),i.instance.start(),_?.setBarColor("red"),R.seconds=0,R.interval=setInterval(()=>R.seconds+=1,1e3),i.state=1)}function Xt(s=!0){if(!(i.state!==1&&i.state!==2)){if(!i.instance||!s){i?.instance?.stop(),i.instance=null,i.state=0,_?.setBarColor("gray"),R.stop(),R.seconds=-1;return}i.instance.onstop=async()=>{if(!y){i.state=0,i.instance=null;return}const t=await Ut(i.blob).catch(r=>(console.error("[ERR] (FFMPEG) Conversion failed:",r),i.state=0,null));if(!(t instanceof Uint8Array)){console.error("[ERR] (FFMPEG) Conversion failed, output is not Uint8Array."),i.state=0;return}const e=new Blob([t],{type:"audio/mpeg"}),{emotion:a,played:n}=await y?.sendAudioAndWait(e);if(at(a),i.mode==="voice")await n;else{const r=Math.random()<.5?2:3;for(let l=0;l<r;l++)await mt(void 0,0)}i.instance=null,i.state=0,at(gt.neutral)},i.instance.stop(),_?.setBarColor("gray"),R.stop(),i.state=3}}function Yt(){i.state===1&&i.instance&&(i.instance.pause(),i.state=2,_?.setBarColor("gray"),R.pause())}function Vt(){i.state===2&&i.instance&&(i.instance.resume(),i.state=1,_?.setBarColor("red"),R.resume())}const Kt={barColor:"gray",barWidth:5,barGap:5},$t=function(s){const t=new ResizeObserver(()=>{const n=s.clientWidth??0,r=s.clientHeight??0;s.width=n*devicePixelRatio,s.height=r*devicePixelRatio,s.style.width=`${n}px`,s.style.height=`${r}px`});t.observe(s);const e=_=new Z(s,s.getContext("2d"),Kt),a=()=>e.draw();return bt(a),i.state=4,rt(),wt(!0),{destroy(){t.unobserve(s),e.destroy(),Rt(a)}}};var qt=()=>history.back(),Jt=D('<div class="button-list"><button class="button svelte-g952jj">返回</button> <button class="button svelte-g952jj">開始錄音</button></div>'),Qt=()=>history.back(),Zt=D('<div class="button-list"><button class="button svelte-g952jj">返回</button> <button class="button svelte-g952jj">開始</button></div>'),te=()=>i.pauseRecording(),ee=()=>i.stopRecording(!0),se=D('<div class="button-list"><button class="button svelte-g952jj">暫停</button> <button class="button svelte-g952jj">送出</button></div>'),ae=()=>i.resumeRecording(),ie=()=>i.stopRecording(!1),ne=()=>i.stopRecording(!0),oe=D('<div class="button-list"><button class="button svelte-g952jj">繼續</button> <button class="button svelte-g952jj">終止</button> <button class="button svelte-g952jj">送出</button></div>'),re=()=>history.back(),ce=D('<div class="button-list"><button class="button svelte-g952jj">返回</button> <button class="button svelte-g952jj" disabled>開始錄音</button></div>'),le=()=>i.toggleMode(),de=D('<div class="container svelte-g952jj"><div class="canvas-container svelte-g952jj"><div class="timer svelte-g952jj"> </div> <canvas class="svelte-g952jj"></canvas></div> <!> <button type="button" class="toggler svelte-g952jj"><img alt="翻譯機" draggable="false" class="svelte-g952jj"/> <span class="label svelte-g952jj"> </span></button></div>');function ve(s,t){dt(t,!1),ut();var e=de(),a=v(e),n=v(a),r=v(n),l=g(n,2);yt(l,f=>$t?.(f));var o=g(a,2);{var u=f=>{var L=Jt(),j=v(L);j.__click=[qt];var B=g(j,2);B.__click=function(...X){i.initialize?.apply(this,X)},et(()=>B.disabled=i.initializing),E(f,L)},p=f=>{var L=T(),j=G(L);{var B=k=>{var S=Zt(),M=v(S);M.__click=[Qt];var Y=g(M,2);Y.__click=function(...V){i.startRecording?.apply(this,V)},E(k,S)},X=k=>{var S=T(),M=G(S);{var Y=C=>{var O=se(),W=v(O);W.__click=[te];var K=g(W,2);K.__click=[ee],E(C,O)},V=C=>{var O=T(),W=G(O);{var K=A=>{var I=oe(),N=v(I);N.__click=[ae];var U=g(N,2);U.__click=[ie];var P=g(U,2);P.__click=[ne],E(A,I)},ct=A=>{var I=T(),N=G(I);{var U=P=>{var tt=ce(),lt=v(tt);lt.__click=[re],E(P,tt)};F(N,P=>{(i.state===i.PROCESSING||i.state===i.FAILED)&&P(U)},!0)}E(A,I)};F(W,A=>{i.state===i.PAUSED?A(K):A(ct,!1)},!0)}E(C,O)};F(M,C=>{i.state===i.RECORDING?C(Y):C(V,!1)},!0)}E(k,S)};F(j,k=>{i.state===i.READY?k(B):k(X,!1)},!0)}E(f,L)};F(o,f=>{i.state===i.UNGRANTED?f(u):f(p,!1)})}var d=g(o,2);d.__click=[le];var m=v(d);let h;var z=g(m,2),x=v(z);et(f=>{st(r,i.state===i.FAILED?"出現未知錯誤":R.formatted),Ct(m,"src",kt.chat.src),h=_t(m,"",h,f),st(x,`翻譯：${i.mode===Q.Voice?"開":"關"}`)},[()=>({filter:i.mode===Q.Voice?"none":"grayscale(100%)"})]),E(s,e),ht()}ft(["click"]);export{ve as default};
