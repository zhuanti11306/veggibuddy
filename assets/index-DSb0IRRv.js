import{n as at,p as ct,i as lt,h as F,C as p,l as u,O as ut,u as M,A as tt,B as et,H as dt,G as ht,b as d,g as ft,c as I,f as z,d as vt}from"./vendor-BHUJVZvY.js";import{t as pt,A as mt,E as gt,v as nt,w as bt,x as yt,y as wt,z as kt,B as _t,C as Ct,o as Et}from"./settings.svelte-5XoKg5x_.js";import{F as Ft,t as st}from"./ffmpeg-H-PQBhfF.js";import"./firebase-Nwrn9kXS.js";class m extends EventTarget{static audioContext;static communications=new Map;readyState="loading";socket;token;currentAudio;isResponding=!1;autoPlay=!0;constructor(e){super(),this.initializeConnection(e)}async initializeConnection(e){try{const s=await Promise.resolve(e);this.token=s,m.communications.has(s)?this.socket=m.communications.get(s):(this.socket=new WebSocket(`${gt.API.WS_BASE_URL}/response/${s}`),m.communications.set(s,this.socket)),this.socket?.readyState===WebSocket.OPEN?this.setupSocketHandlers():this.socket?.addEventListener("open",()=>this.setupSocketHandlers())}catch(s){this.readyState="error",this.dispatchEvent(new CustomEvent("error",{detail:s}))}}setupSocketHandlers(){this.socket&&(this.readyState="ready",this.dispatchEvent(new CustomEvent("ready")),this.socket.addEventListener("message",async e=>{const s=JSON.parse(e.data);if(this.dispatchEvent(new CustomEvent("message",{detail:s})),this.dispatchEvent(new CustomEvent("received",{detail:s.emotion})),!this.autoPlay)return;const a=await this.playAudio(s.audio);a&&(await a.promise,this.dispatchEvent(new CustomEvent("played",{detail:s.emotion})))}),this.socket.addEventListener("close",()=>{this.readyState="error"}),this.socket.addEventListener("error",e=>{this.readyState="error"}))}async playAudio(e){try{const s=atob(e),a=new Uint8Array(s.length);for(let o=0;o<s.length;o++)a[o]=s.charCodeAt(o);const i=this.getAudioContext(),r=await i.decodeAudioData(a.buffer);return this.currentAudio?.stop(),this.currentAudio=i.createBufferSource(),this.currentAudio.buffer=r,this.currentAudio.connect(i.destination),{promise:new Promise(o=>{this.currentAudio.onended=()=>{this.currentAudio=void 0,o()},this.currentAudio.start(0)})}}catch{}finally{this.isResponding=!1}}getAudioContext(){return m.audioContext||(m.audioContext=new AudioContext),m.audioContext}canSendMessage(){return!(!this.socket||this.readyState!=="ready"||this.isResponding)}async waitForReady(){return this.readyState==="ready"&&!this.isResponding?this:new Promise((e,s)=>{const a=()=>{this.readyState==="ready"&&!this.isResponding&&(this.removeEventListener("ready",a),this.removeEventListener("received",a),e(this))},i=r=>{this.removeEventListener("ready",a),this.removeEventListener("received",a),this.removeEventListener("error",i),s(r.detail)};this.addEventListener("ready",a),this.addEventListener("received",a),this.addEventListener("error",i)})}sendAudio(e){return this.canSendMessage()?(this.socket.send(e),this.isResponding=!0,!0):!1}async sendAudioAndWait(e,s){if(await this.waitForReady(),!this.sendAudio(e))throw new Error("無法發送音訊");const a=new Promise(c=>{this.addEventListener("received",o=>c(o.detail),{once:!0})}),i=this.autoPlay?new Promise(c=>{this.addEventListener("played",()=>c(),{once:!0})}):Promise.resolve();return{emotion:await a,played:i}}close(){this.socket&&this.token&&(this.socket.close(),m.communications.delete(this.token),this.socket=void 0),this.currentAudio?.stop(),this.currentAudio=void 0}}class At{static instance;static getConversation(){if(!this.instance){const e=pt(mt.chatGetToken).then(s=>s.session_token);this.instance=new m(e)}return this.instance}static closeConversation(){this.instance&&(this.instance.close(),this.instance=void 0)}}const g=new Ft,Rt={coreURL:await st("https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/esm/ffmpeg-core.js","text/javascript"),wasmURL:await st("https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/esm/ffmpeg-core.wasm","application/wasm")};async function St(){return g.loaded?!0:g.load(Rt).then(()=>!0).catch(n=>(console.error("[ERR] (FFMPEG) Failed to load FFmpeg:",n),!1))}async function xt(n){const e=await Promise.allSettled(n.map(s=>g.deleteFile(s)));for(const s of e)s.status==="rejected"&&console.warn("[WRN] (FFMPEG) Failed to delete file:",s.reason)}const X="input.webm",K="output.mp3";async function jt(n,e){if(g.loaded===!1)return console.error("[ERR] (FFMPEG) FFmpeg is not loaded"),null;await g.writeFile(X,new Uint8Array(await n.arrayBuffer()),{signal:e}),await g.exec(["-i",X,K],-1,{signal:e});const s=await g.readFile(K,"binary",{signal:e});return await Pt(),s instanceof Uint8Array?s:(console.error("[ERR] (FFMPEG) Failed to convert WebM to MP3: output is not Uint8Array"),null)}async function Pt(){return xt([X,K])}class Z{static defaultOptions={clearWhenDraw:!0,barColor:"black",barWidth:3,barGap:1,fftsize:2048,durationSec:.5};canvas;context;options;stream=null;audioContext=null;analyser=null;dataChunk=null;waveformBuffer=null;bufferHead=0;constructor(e,s,a){if(this.canvas=e,this.context=s,s.canvas!==e)throw new Error("Canvas and context do not match.");this.options={...Z.defaultOptions,...a}}setStream(e){this.stream=e,this.audioContext=new AudioContext;const s=this.audioContext.createMediaStreamSource(this.stream);this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.options.fftsize,this.dataChunk=new Float32Array(this.analyser.frequencyBinCount);const a=this.audioContext.sampleRate,i=this.options.durationSec??.5,r=Math.ceil(a*i);this.waveformBuffer=new Float32Array(r),this.bufferHead=0,s.connect(this.analyser)}setFFTSize(e){this.options.fftsize=e,this.analyser&&(this.analyser.fftSize=e,this.dataChunk&&(this.dataChunk=new Float32Array(this.analyser.frequencyBinCount)))}setDuration(e){if(this.options.durationSec=e,this.audioContext&&this.waveformBuffer){const s=this.audioContext.sampleRate,a=Math.ceil(s*e);this.waveformBuffer=new Float32Array(a),this.bufferHead=0}}toggleClearWhenDraw(e){this.options.clearWhenDraw=e??!this.options.clearWhenDraw}setBarColor(e){this.options.barColor=e}setBarWidth(e){this.options.barWidth=e}setBarGap(e){this.options.barGap=e}draw(){const e=this.context,s=this.canvas.width,a=this.canvas.height;(this.options.clearWhenDraw??!0)&&e.clearRect(0,0,s,a),e.save();const i=this.options.barWidth+this.options.barGap,r=Math.floor(s/i);!this.analyser||!this.dataChunk||!this.waveformBuffer?this.drawWaiting(r):this.drawWaveform(r),e.restore()}destroy(){if(this.stream){for(const e of this.stream.getTracks())this.stream.removeTrack(e);this.stream=null}this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.analyser&&(this.analyser.disconnect(),this.analyser=null)}waitingLineOffset=0;drawWaiting(e){const s=[];this.waitingLineOffset=(this.waitingLineOffset+.25)%e;for(let a=0;a<e;a++){const i=(a+this.waitingLineOffset)%e-e/2,r=1.05**-(i*i)*.5*Math.sin(i/5+a/3),c=this.canvas.height/2*(1-r),o=this.canvas.height/2;s.push([c,o])}this.drawLines(s)}drawWaveform(e){if(!this.analyser||!this.dataChunk||!this.waveformBuffer)return;this.canvas.width;const s=this.canvas.height;this.analyser.getFloatTimeDomainData(this.dataChunk);for(let c=0;c<this.dataChunk.length;c++)this.waveformBuffer[this.bufferHead]=this.dataChunk[c],this.bufferHead=(this.bufferHead+1)%this.waveformBuffer.length;const a=this.waveformBuffer.length,i=Math.floor(a/e),r=[];for(let c=0;c<e;c++){const o=c*i;let v=0;for(let k=0;k<i;k++){const N=(this.bufferHead+o+k)%a,L=Math.abs(this.waveformBuffer[N]);L>v&&(v=L)}const w=Math.max(v,.0078625)*s,b=s/2-w/2,A=s/2+w/2;r.push([b,A])}this.drawLines(r)}drawLines(e){const s=this.context,a=this.canvas.width;s.lineWidth=this.options.barWidth,s.strokeStyle=this.options.barColor,s.lineCap="round";const i=this.options.barWidth+this.options.barGap,r=Math.floor(a/i),c=(a-r*i)/2+this.options.barGap;for(let o=0;o<e.length;o++){const v=e[o][0],w=e[o][1],b=o*i+c;s.beginPath(),s.moveTo(b,v),s.lineTo(b,w),s.stroke()}}}var Mt=(n=>(n[n.Success=0]="Success",n[n.Ungranted=1]="Ungranted",n[n.Failed=2]="Failed",n))(Mt||{});const f=at({seconds:-1,interval:null,get formatted(){const n=e=>{const s=Math.max(0,e),a=Math.floor(s/60).toString().padStart(2,"0"),i=(s%60).toString().padStart(2,"0");return`${a} : ${i}`};switch(t.state){case 3:return"思考中...";case 5:return"發生錯誤";case 4:return"等待授權";case 1:case 2:return n(this.seconds);case 0:default:return"-- : --"}},start(){this.resume(),this.seconds=0},stop(){this.pause(),this.seconds=-1},resume(){this.interval||(this.interval=setInterval(()=>this.seconds+=1,1e3))},pause(){this.interval&&(clearInterval(this.interval),this.interval=null)}}),J=[];var Q=(n=>(n.Voice="voice",n.Sound="sound",n))(Q||{});const t=at({state:4,initializing:!1,recorderInstance:null,READY:0,RECORDING:1,PAUSED:2,PROCESSING:3,UNGRANTED:4,FAILED:5,get instance(){return this.recorderInstance},set instance(n){if(!n){this.recorderInstance&&(this.recorderInstance.onstop=null,this.recorderInstance.ondataavailable=null,this.recorderInstance.stop());return}J.length=0,this.recorderInstance=n,n.ondataavailable=e=>{J.push(e.data)}},get blob(){return new Blob(J,{type:"audio/webm"})},startRecording:Bt,stopRecording:Wt,pauseRecording:Dt,resumeRecording:Gt,initialize:it,mode:"voice",toggleMode(){switch(this.mode){case"voice":this.mode="sound",h&&(h.autoPlay=!1);break;case"sound":this.mode="voice",h&&(h.autoPlay=!0);break}}});let H=null,h=null,y=null;async function it(){if(t.state!==4||t.initializing)return;if(!("mediaDevices"in navigator)){console.warn("[WRN] (Media) Media Devices API not supported."),t.state=5;return}const n=navigator.mediaDevices.getUserMedia({audio:!0}).then(o=>({stream:o,result:0})).catch(o=>({error:o,result:1})),e=At.getConversation().waitForReady().then(o=>({conversation:o,result:0})).catch(o=>({error:o,result:2})),s=g.loaded?Promise.resolve({result:0}):St().then(o=>({result:o?0:2})).catch(o=>({error:o,result:2}));t.initializing=!0;const a=await Promise.all([n,e,s]),[i,r]=a;switch(a.reduce((o,v)=>Math.max(v.result,o),0)){case 0:H=i.stream,Lt(r.conversation),t.state=0,y?.setStream(H);break;case 1:t.state=4;break;case 2:t.state=5;break}t.initializing=!1}function Lt(n){h=n,h.autoPlay=t.mode==="voice"}function Bt(){t.state===0&&H&&(t.instance=new MediaRecorder(H),t.instance.start(),y?.setBarColor("red"),f.seconds=0,f.interval=setInterval(()=>f.seconds+=1,1e3),t.state=1)}function Wt(n=!0){if(!(t.state!==1&&t.state!==2)){if(!t.instance||!n){t.instance&&(t.instance.onstop=null,t.instance.ondataavailable=null,t.instance.stop()),t.instance=null,t.state=0,y?.setBarColor("gray"),f.stop(),f.seconds=-1;return}t.instance.onstop=async()=>{if(!t.instance)return;if(!h){t.state=0,t.instance=null;return}const e=await jt(t.blob).catch(r=>(console.error("[ERR] (FFMPEG) Conversion failed:",r),t.state=0,null));if(!t.instance)return;if(!(e instanceof Uint8Array)){console.error("[ERR] (FFMPEG) Conversion failed, output is not Uint8Array."),t.state=0;return}const s=new Blob([e],{type:"audio/mpeg"}),{emotion:a,played:i}=await h?.sendAudioAndWait(s);if(t.instance){if(nt(a),t.mode==="voice")await i;else{const r=Math.random()<.5?2:3;for(let c=0;c<r&&t.instance;c++)await bt(void 0,0,!0)}t.instance&&(yt("CHAT"),t.instance=null,t.state=0)}},t.instance.stop(),y?.setBarColor("gray"),f.stop(),t.state=3}}function Dt(){t.state===1&&t.instance&&(t.instance.pause(),t.state=2,y?.setBarColor("gray"),f.pause())}function Gt(){t.state===2&&t.instance&&(t.instance.resume(),t.state=1,y?.setBarColor("red"),f.resume())}const Tt={barColor:"gray",barWidth:5,barGap:5},Ut=function(n){const e=new ResizeObserver(()=>{const i=n.clientWidth??0,r=n.clientHeight??0;n.width=i*devicePixelRatio,n.height=r*devicePixelRatio,n.style.width=`${i}px`,n.style.height=`${r}px`});e.observe(n);const s=y=new Z(n,n.getContext("2d"),Tt),a=()=>s.draw();return wt(a),t.state=4,it(),kt(!0),{destroy(){e.unobserve(n),s.destroy(),_t(a),f.stop(),h&&(h.autoPlay=!1),t.instance&&(t.instance.onstop=null,t.instance.ondataavailable=null,t.instance.stop(),t.instance=null),t.state=4,t.initializing=!1,nt(Ct.neutral)}}};var It=()=>history.back(),zt=F('<div class="button-list"><button class="button svelte-g952jj">返回</button> <button class="button svelte-g952jj">開始錄音</button></div>'),Ht=()=>history.back(),Nt=F('<div class="button-list"><button class="button svelte-g952jj">返回</button> <button class="button svelte-g952jj">開始</button></div>'),Ot=()=>t.pauseRecording(),Vt=()=>t.stopRecording(!0),Yt=F('<div class="button-list"><button class="button svelte-g952jj">暫停</button> <button class="button svelte-g952jj">送出</button></div>'),qt=()=>t.resumeRecording(),Jt=()=>t.stopRecording(!1),Xt=()=>t.stopRecording(!0),Kt=F('<div class="button-list"><button class="button svelte-g952jj">繼續</button> <button class="button svelte-g952jj">終止</button> <button class="button svelte-g952jj">送出</button></div>'),Qt=()=>history.back(),Zt=F('<div class="button-list"><button class="button svelte-g952jj">返回</button> <button class="button svelte-g952jj" disabled>開始錄音</button></div>'),$t=()=>t.toggleMode(),te=F('<div class="container svelte-g952jj"><div class="canvas-container svelte-g952jj"><div class="timer svelte-g952jj"> </div> <canvas class="svelte-g952jj"></canvas></div> <!> <button type="button" class="toggler svelte-g952jj"><img alt="翻譯機" draggable="false" class="svelte-g952jj"/> <span class="label svelte-g952jj"> </span></button></div>');function ie(n,e){ct(e,!1),lt();var s=te(),a=u(s),i=u(a),r=u(i),c=p(i,2);ut(c,l=>Ut?.(l));var o=p(a,2);{var v=l=>{var R=zt(),B=u(R);B.__click=[It];var W=p(B,2);W.__click=function(...O){t.initialize?.apply(this,O)},tt(()=>W.disabled=t.initializing),d(l,R)},w=l=>{var R=I(),B=z(R);{var W=_=>{var S=Nt(),D=u(S);D.__click=[Ht];var V=p(D,2);V.__click=function(...Y){t.startRecording?.apply(this,Y)},d(_,S)},O=_=>{var S=I(),D=z(S);{var V=C=>{var x=Yt(),G=u(x);G.__click=[Ot];var q=p(G,2);q.__click=[Vt],d(C,x)},Y=C=>{var x=I(),G=z(x);{var q=E=>{var j=Kt(),T=u(j);T.__click=[qt];var U=p(T,2);U.__click=[Jt];var P=p(U,2);P.__click=[Xt],d(E,j)},ot=E=>{var j=I(),T=z(j);{var U=P=>{var $=Zt(),rt=u($);rt.__click=[Qt],d(P,$)};M(T,P=>{(t.state===t.PROCESSING||t.state===t.FAILED)&&P(U)},!0)}d(E,j)};M(G,E=>{t.state===t.PAUSED?E(q):E(ot,!1)},!0)}d(C,x)};M(D,C=>{t.state===t.RECORDING?C(V):C(Y,!1)},!0)}d(_,S)};M(B,_=>{t.state===t.READY?_(W):_(O,!1)},!0)}d(l,R)};M(o,l=>{t.state===t.UNGRANTED?l(v):l(w,!1)})}var b=p(o,2);b.__click=[$t];var A=u(b);let k;var N=p(A,2),L=u(N);tt(l=>{et(r,t.state===t.FAILED?"出現未知錯誤":f.formatted),dt(A,"src",Et.chat.src),k=ht(A,"",k,l),et(L,`翻譯：${t.mode===Q.Voice?"開":"關"}`)},[()=>({filter:t.mode===Q.Voice?"none":"grayscale(100%)"})]),d(n,s),ft()}vt(["click"]);export{ie as default};
