import{n as it,p as ct,i as lt,h as F,C as f,l as d,O as dt,u as M,A as tt,B as et,F as ut,H as ht,b as u,g as ft,c as T,f as z,d as vt}from"./vendor-BEoA47yD.js";import{w as pt,A as mt,E as gt,x as st,y as bt,z as yt,P as wt,B as kt,C as _t,D as Ct,t as Et}from"./settings.svelte-DYu5eymu.js";import{F as Ft,t as at}from"./ffmpeg-H-PQBhfF.js";import"./firebase-LKE9M92C.js";class v extends EventTarget{static audioContext;static communications=new Map;readyState="loading";socket;token;currentAudio;isResponding=!1;autoPlay=!0;constructor(t){super(),this.initializeConnection(t)}async initializeConnection(t){try{const e=await Promise.resolve(t);this.token=e,v.communications.has(e)?this.socket=v.communications.get(e):(this.socket=new WebSocket(`${gt.API.WS_BASE_URL}/response/${e}`),v.communications.set(e,this.socket)),this.socket?.readyState===WebSocket.OPEN?this.setupSocketHandlers():this.socket?.addEventListener("open",()=>this.setupSocketHandlers())}catch(e){this.readyState="error",this.dispatchEvent(new CustomEvent("error",{detail:e}))}}setupSocketHandlers(){this.socket&&(this.readyState="ready",this.dispatchEvent(new CustomEvent("ready")),this.socket.addEventListener("message",async t=>{const e=JSON.parse(t.data);if(this.dispatchEvent(new CustomEvent("message",{detail:e})),this.dispatchEvent(new CustomEvent("received",{detail:e.emotion})),!this.autoPlay)return;const a=await this.playAudio(e.audio);a&&(await a.promise,this.dispatchEvent(new CustomEvent("played",{detail:e.emotion})))}),this.socket.addEventListener("close",()=>{this.readyState="error"}),this.socket.addEventListener("error",t=>{this.readyState="error"}))}async playAudio(t){try{const e=atob(t),a=new Uint8Array(e.length);for(let n=0;n<e.length;n++)a[n]=e.charCodeAt(n);const o=this.getAudioContext(),r=await o.decodeAudioData(a.buffer);return this.currentAudio?.stop(),this.currentAudio=o.createBufferSource(),this.currentAudio.buffer=r,this.currentAudio.connect(o.destination),{promise:new Promise(n=>{this.currentAudio.onended=()=>{this.currentAudio=void 0,n()},this.currentAudio.start(0)})}}catch{}finally{this.isResponding=!1}}getAudioContext(){return v.audioContext||(v.audioContext=new AudioContext),v.audioContext}canSendMessage(){return!(!this.socket||this.readyState!=="ready"||this.isResponding)}async waitForReady(){return this.readyState==="ready"&&!this.isResponding?this:new Promise((t,e)=>{const a=()=>{this.readyState==="ready"&&!this.isResponding&&(this.removeEventListener("ready",a),this.removeEventListener("received",a),t(this))},o=r=>{this.removeEventListener("ready",a),this.removeEventListener("received",a),this.removeEventListener("error",o),e(r.detail)};this.addEventListener("ready",a),this.addEventListener("received",a),this.addEventListener("error",o)})}sendAudio(t){return this.canSendMessage()?(this.socket.send(t),this.isResponding=!0,!0):!1}async sendAudioAndWait(t){if(await this.waitForReady(),!this.sendAudio(t))throw new Error("無法發送音訊");const e=new Promise(r=>{this.addEventListener("received",c=>r(c.detail),{once:!0})}),a=this.autoPlay?new Promise(r=>{this.addEventListener("played",()=>r(),{once:!0})}):Promise.resolve();return{emotion:await e,played:a}}close(){this.socket&&this.token&&(this.socket.close(),v.communications.delete(this.token),this.socket=void 0),this.currentAudio?.stop(),this.currentAudio=void 0}}class At{static instance;static getConversation(){if(!this.instance){const t=pt(mt.chatGetToken).then(e=>e.session_token);this.instance=new v(t)}return this.instance}static closeConversation(){this.instance&&(this.instance.close(),this.instance=void 0)}}const m=new Ft,Rt={coreURL:await at("https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/esm/ffmpeg-core.js","text/javascript"),wasmURL:await at("https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/esm/ffmpeg-core.wasm","application/wasm")};async function St(){return m.loaded?!0:m.load(Rt).then(()=>!0).catch(i=>(console.error("[ERR] (FFMPEG) Failed to load FFmpeg:",i),!1))}async function xt(i){const t=await Promise.allSettled(i.map(e=>m.deleteFile(e)));for(const e of t)e.status==="rejected"&&console.warn("[WRN] (FFMPEG) Failed to delete file:",e.reason)}const X="input.webm",K="output.mp3";async function jt(i,t){if(m.loaded===!1)return console.error("[ERR] (FFMPEG) FFmpeg is not loaded"),null;await m.writeFile(X,new Uint8Array(await i.arrayBuffer()),{signal:t}),await m.exec(["-i",X,K],-1,{signal:t});const e=await m.readFile(K,"binary",{signal:t});return await Pt(),e instanceof Uint8Array?e:(console.error("[ERR] (FFMPEG) Failed to convert WebM to MP3: output is not Uint8Array"),null)}async function Pt(){return xt([X,K])}class Z{static defaultOptions={clearWhenDraw:!0,barColor:"black",barWidth:3,barGap:1,fftsize:2048,durationSec:.5};canvas;context;options;stream=null;audioContext=null;analyser=null;dataChunk=null;waveformBuffer=null;bufferHead=0;constructor(t,e,a){if(this.canvas=t,this.context=e,e.canvas!==t)throw new Error("Canvas and context do not match.");this.options={...Z.defaultOptions,...a}}setStream(t){this.stream=t,this.audioContext=new AudioContext;const e=this.audioContext.createMediaStreamSource(this.stream);this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.options.fftsize,this.dataChunk=new Float32Array(this.analyser.frequencyBinCount);const a=this.audioContext.sampleRate,o=this.options.durationSec??.5,r=Math.ceil(a*o);this.waveformBuffer=new Float32Array(r),this.bufferHead=0,e.connect(this.analyser)}setFFTSize(t){this.options.fftsize=t,this.analyser&&(this.analyser.fftSize=t,this.dataChunk&&(this.dataChunk=new Float32Array(this.analyser.frequencyBinCount)))}setDuration(t){if(this.options.durationSec=t,this.audioContext&&this.waveformBuffer){const e=this.audioContext.sampleRate,a=Math.ceil(e*t);this.waveformBuffer=new Float32Array(a),this.bufferHead=0}}toggleClearWhenDraw(t){this.options.clearWhenDraw=t??!this.options.clearWhenDraw}setBarColor(t){this.options.barColor=t}setBarWidth(t){this.options.barWidth=t}setBarGap(t){this.options.barGap=t}draw(){const t=this.context,e=this.canvas.width,a=this.canvas.height;(this.options.clearWhenDraw??!0)&&t.clearRect(0,0,e,a),t.save();const o=this.options.barWidth+this.options.barGap,r=Math.floor(e/o);!this.analyser||!this.dataChunk||!this.waveformBuffer?this.drawWaiting(r):this.drawWaveform(r),t.restore()}destroy(){if(this.stream){for(const t of this.stream.getTracks())this.stream.removeTrack(t);this.stream=null}this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.analyser&&(this.analyser.disconnect(),this.analyser=null)}waitingLineOffset=0;drawWaiting(t){const e=[];this.waitingLineOffset=(this.waitingLineOffset+.25)%t;for(let a=0;a<t;a++){const o=(a+this.waitingLineOffset)%t-t/2,r=1.05**-(o*o)*.5*Math.sin(o/5+a/3),c=this.canvas.height/2*(1-r),n=this.canvas.height/2;e.push([c,n])}this.drawLines(e)}drawWaveform(t){if(!this.analyser||!this.dataChunk||!this.waveformBuffer)return;this.canvas.width;const e=this.canvas.height;this.analyser.getFloatTimeDomainData(this.dataChunk);for(let c=0;c<this.dataChunk.length;c++)this.waveformBuffer[this.bufferHead]=this.dataChunk[c],this.bufferHead=(this.bufferHead+1)%this.waveformBuffer.length;const a=this.waveformBuffer.length,o=Math.floor(a/t),r=[];for(let c=0;c<t;c++){const n=c*o;let h=0;for(let k=0;k<o;k++){const N=(this.bufferHead+n+k)%a,B=Math.abs(this.waveformBuffer[N]);B>h&&(h=B)}const w=Math.max(h,.0078625)*e,g=e/2-w/2,A=e/2+w/2;r.push([g,A])}this.drawLines(r)}drawLines(t){const e=this.context,a=this.canvas.width;e.lineWidth=this.options.barWidth,e.strokeStyle=this.options.barColor,e.lineCap="round";const o=this.options.barWidth+this.options.barGap,r=Math.floor(a/o),c=(a-r*o)/2+this.options.barGap;for(let n=0;n<t.length;n++){const h=t[n][0],w=t[n][1],g=n*o+c;e.beginPath(),e.moveTo(g,h),e.lineTo(g,w),e.stroke()}}}var Mt=(i=>(i[i.Success=0]="Success",i[i.Ungranted=1]="Ungranted",i[i.Failed=2]="Failed",i))(Mt||{});const p=it({seconds:-1,interval:null,get formatted(){if(this.seconds<0)return"-- : --";const i=Math.floor(this.seconds/60).toString().padStart(2,"0"),t=(this.seconds%60).toString().padStart(2,"0");return`${i} : ${t}`},start(){this.resume(),this.seconds=0},stop(){this.pause(),this.seconds=-1},resume(){this.interval||(this.interval=setInterval(()=>this.seconds+=1,1e3))},pause(){this.interval&&(clearInterval(this.interval),this.interval=null)}}),J=[];var Q=(i=>(i.Voice="voice",i.Sound="sound",i))(Q||{});const s=it({state:4,initializing:!1,recorderInstance:null,READY:0,RECORDING:1,PAUSED:2,PROCESSING:3,UNGRANTED:4,FAILED:5,get instance(){return this.recorderInstance},set instance(i){if(!i){this.recorderInstance&&(this.recorderInstance.onstop=null,this.recorderInstance.ondataavailable=null,this.recorderInstance.stop());return}J.length=0,this.recorderInstance=i,i.ondataavailable=t=>{J.push(t.data)}},get blob(){return new Blob(J,{type:"audio/webm"})},startRecording:Lt,stopRecording:Dt,pauseRecording:Wt,resumeRecording:Gt,initialize:nt,mode:"voice",toggleMode(){switch(this.mode){case"voice":this.mode="sound",b&&(b.autoPlay=!1);break;case"sound":this.mode="voice",b&&(b.autoPlay=!0);break}}});let H=null,b=null,y=null;async function nt(){if(s.state!==4||s.initializing)return;if(!("mediaDevices"in navigator)){console.warn("[WRN] (Media) Media Devices API not supported."),s.state=5;return}const i=navigator.mediaDevices.getUserMedia({audio:!0}).then(n=>({stream:n,result:0})).catch(n=>({error:n,result:1})),t=At.getConversation().waitForReady().then(n=>({conversation:n,result:0})).catch(n=>({error:n,result:2})),e=m.loaded?Promise.resolve({result:0}):St().then(n=>({result:n?0:2})).catch(n=>({error:n,result:2}));s.initializing=!0;const a=await Promise.all([i,t,e]),[o,r]=a;switch(console.log("[DBG] (Media) Initialization results:",a),a.reduce((n,h)=>Math.max(h.result,n),0)){case 0:H=o.stream,Bt(r.conversation),s.state=0,y?.setStream(H);break;case 1:s.state=4;break;case 2:s.state=5;break}s.initializing=!1}function Bt(i){b=i}function Lt(){s.state===0&&H&&(s.instance=new MediaRecorder(H),s.instance.start(),y?.setBarColor("red"),p.seconds=0,p.interval=setInterval(()=>p.seconds+=1,1e3),s.state=1)}function Dt(i=!0){if(!(s.state!==1&&s.state!==2)){if(!s.instance||!i){s?.instance?.stop(),s.instance=null,s.state=0,y?.setBarColor("gray"),p.stop(),p.seconds=-1;return}s.instance.onstop=async()=>{if(!b){s.state=0,s.instance=null;return}const t=await jt(s.blob).catch(r=>(console.error("[ERR] (FFMPEG) Conversion failed:",r),s.state=0,null));if(!(t instanceof Uint8Array)){console.error("[ERR] (FFMPEG) Conversion failed, output is not Uint8Array."),s.state=0;return}const e=new Blob([t],{type:"audio/mpeg"}),{emotion:a,played:o}=await b?.sendAudioAndWait(e);if(st(a),s.mode==="voice")await o;else{const r=Math.random()<.5?2:3;for(let c=0;c<r;c++)await bt(void 0,0)}yt("CHAT"),s.instance=null,s.state=0,st(wt.neutral)},s.instance.stop(),y?.setBarColor("gray"),p.stop(),s.state=3}}function Wt(){s.state===1&&s.instance&&(s.instance.pause(),s.state=2,y?.setBarColor("gray"),p.pause())}function Gt(){s.state===2&&s.instance&&(s.instance.resume(),s.state=1,y?.setBarColor("red"),p.resume())}const It={barColor:"gray",barWidth:5,barGap:5},Ut=function(i){const t=new ResizeObserver(()=>{const o=i.clientWidth??0,r=i.clientHeight??0;i.width=o*devicePixelRatio,i.height=r*devicePixelRatio,i.style.width=`${o}px`,i.style.height=`${r}px`});t.observe(i);const e=y=new Z(i,i.getContext("2d"),It),a=()=>e.draw();return kt(a),s.state=4,nt(),_t(!0),{destroy(){t.unobserve(i),e.destroy(),Ct(a)}}};var Tt=()=>history.back(),zt=F('<div class="button-list"><button class="button svelte-g952jj">返回</button> <button class="button svelte-g952jj">開始錄音</button></div>'),Ht=()=>history.back(),Nt=F('<div class="button-list"><button class="button svelte-g952jj">返回</button> <button class="button svelte-g952jj">開始</button></div>'),Ot=()=>s.pauseRecording(),Vt=()=>s.stopRecording(!0),Yt=F('<div class="button-list"><button class="button svelte-g952jj">暫停</button> <button class="button svelte-g952jj">送出</button></div>'),qt=()=>s.resumeRecording(),Jt=()=>s.stopRecording(!1),Xt=()=>s.stopRecording(!0),Kt=F('<div class="button-list"><button class="button svelte-g952jj">繼續</button> <button class="button svelte-g952jj">終止</button> <button class="button svelte-g952jj">送出</button></div>'),Qt=()=>history.back(),Zt=F('<div class="button-list"><button class="button svelte-g952jj">返回</button> <button class="button svelte-g952jj" disabled>開始錄音</button></div>'),$t=()=>s.toggleMode(),te=F('<div class="container svelte-g952jj"><div class="canvas-container svelte-g952jj"><div class="timer svelte-g952jj"> </div> <canvas class="svelte-g952jj"></canvas></div> <!> <button type="button" class="toggler svelte-g952jj"><img alt="翻譯機" draggable="false" class="svelte-g952jj"/> <span class="label svelte-g952jj"> </span></button></div>');function ne(i,t){ct(t,!1),lt();var e=te(),a=d(e),o=d(a),r=d(o),c=f(o,2);dt(c,l=>Ut?.(l));var n=f(a,2);{var h=l=>{var R=zt(),L=d(R);L.__click=[Tt];var D=f(L,2);D.__click=function(...O){s.initialize?.apply(this,O)},tt(()=>D.disabled=s.initializing),u(l,R)},w=l=>{var R=T(),L=z(R);{var D=_=>{var S=Nt(),W=d(S);W.__click=[Ht];var V=f(W,2);V.__click=function(...Y){s.startRecording?.apply(this,Y)},u(_,S)},O=_=>{var S=T(),W=z(S);{var V=C=>{var x=Yt(),G=d(x);G.__click=[Ot];var q=f(G,2);q.__click=[Vt],u(C,x)},Y=C=>{var x=T(),G=z(x);{var q=E=>{var j=Kt(),I=d(j);I.__click=[qt];var U=f(I,2);U.__click=[Jt];var P=f(U,2);P.__click=[Xt],u(E,j)},ot=E=>{var j=T(),I=z(j);{var U=P=>{var $=Zt(),rt=d($);rt.__click=[Qt],u(P,$)};M(I,P=>{(s.state===s.PROCESSING||s.state===s.FAILED)&&P(U)},!0)}u(E,j)};M(G,E=>{s.state===s.PAUSED?E(q):E(ot,!1)},!0)}u(C,x)};M(W,C=>{s.state===s.RECORDING?C(V):C(Y,!1)},!0)}u(_,S)};M(L,_=>{s.state===s.READY?_(D):_(O,!1)},!0)}u(l,R)};M(n,l=>{s.state===s.UNGRANTED?l(h):l(w,!1)})}var g=f(n,2);g.__click=[$t];var A=d(g);let k;var N=f(A,2),B=d(N);tt(l=>{et(r,s.state===s.FAILED?"出現未知錯誤":p.formatted),ut(A,"src",Et.chat.src),k=ht(A,"",k,l),et(B,`翻譯：${s.mode===Q.Voice?"開":"關"}`)},[()=>({filter:s.mode===Q.Voice?"none":"grayscale(100%)"})]),u(i,e),ft()}vt(["click"]);export{ne as default};
