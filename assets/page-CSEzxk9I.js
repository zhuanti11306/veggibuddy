import{a as z,G as A,g as S,m as G,p as X,I as B,f as I,c as y,s as x,o as N,t as j,k as C,l as $,d as q}from"./index-CiVeqNK5.js";import{j as U,L as Q,M as Z,O as J,p as P,S as K,z as O,C as W,w as ee,A as te,Q as D,n as oe,T as _}from"./index-DfbJhxeW.js";import{r as ae,t as H,u as ne,v as Y,w as E,M as F,V as se,T as re,e as ie,s as k}from"./GLTFLoader-CQaeW04e.js";let u=null;const{promise:ce,resolve:le}=Promise.withResolvers(),de=1,me=1,L=G(()=>P.isLegal?{id:P.type,assets:J[P.type]}:null),{promise:he,resolve:ue}=Promise.withResolvers();let l=null;function ve(){A(()=>{if(!S(L))return void U();const t=S(L).id;Promise.all([Q(t),ce]).then(([o,{scene:e}])=>{o.model.object&&(e.add(o.model.object),o.model.object.position.set(-.2,.4,0),o.model.object.rotation.set(0,0,0),o.model.object.rotateY(-Math.PI/2),o.model.object.rotateX(-Math.PI/2),ue(o.model.object)),l?.model.object&&e.remove(l.model.object),l=o})})}let w=null;const v=[];async function ge(){if(!w)return console.warn("[WRN] Video canvas not initialized.");if(!u)return console.warn("[WRN] Scene not initialized.");v.length&&(u.scene.remove(...v),v.length=0);const{width:t,height:o}=w.canvas,{scene:e,camera:n}=u,r=w.context.getImageData(0,0,t,o),a=pe(r,n);e.add(a),v.push(a);const{canvas:d}=w;d.toBlob(async s=>{if(s)try{const i=await ee(te.imageObjectDetection,{file:s});if(i.hidingPoint&&l?.model.object){console.log("偵測成功，隱藏點:",i.hidingPoint);const c=be(i.mask,a,r,n);e.add(c),v.push(c);const{x:m,y:h}=i.hidingPoint,f=fe(a,m,h,d.width,d.height),M=a.position.y;l.model.object.position.set(f.x,M,f.z),l.model.object.renderOrder=1,l.model.object.lookAt(n.position),Me()}else console.log("未偵測到合適的隱藏點，請重試"),alert("這裡好像沒有地方可以躲，換個地方拍拍看吧！"),e.remove(...v),v.length=0}catch(i){console.error("偵測發生錯誤:",i),alert("連線錯誤，請稍後再試")}},"image/jpeg")}let p=null,g=null;const b=z({});function pe(t,o){p&&(p.geometry.dispose(),Array.isArray(p.material)?p.material.forEach(f=>f.dispose()):p.material.dispose(),u?.scene.remove(p));const e=new ae(t);e.minFilter=H,e.magFilter=H,e.colorSpace=ne,e.needsUpdate=!0;const n=de,r=t.height/t.width*n,a=new Y(n,r);a.rotateX(-Math.PI/2);const d=new E({map:e}),s=new F(a,d);s.position.set(0,0,0);const i=o.fov*Math.PI/180,m=r/2/Math.tan(i/2),h=me-m;return s.position.y=h,s.userData={width:n,height:r,distanceToCamera:m,y:h},s.renderOrder=0,p=s,s}function fe(t,o,e,n,r){const a=t.userData.width,d=t.userData.height,s=o/n-.5,i=e/r-.5,c=s*a,m=i*d;return new se(c,0,m)}function be(t,o,e,n){g&&(g.geometry.dispose(),g.material.dispose(),g.removeFromParent());const a=new re().load(`data:image/png;base64,${t}`);console.log(`[DBG] data:image/png;base64,${t}`);const d=o.material.map,s=o.userData,i=.5,c=s.y+i,h=(s.distanceToCamera-i)/s.distanceToCamera,f=s.width*h,M=s.height*h,T=new Y(f,M);T.rotateX(-Math.PI/2);const V=new E({map:d,alphaMap:a,transparent:!0,opacity:1,alphaTest:.1});return g=new F(T,V),g.position.set(0,c,0),g.renderOrder=2,console.log(`[DBG] ScreenY: ${s.y}, MaskY: ${c}, Ratio: ${h}`),g}const we=function(t){const o=t.querySelector("#pet");if(!o||!(o instanceof HTMLCanvasElement))throw new Error("Canvas element not found in container.");const e=t.querySelector("#video");if(!e||!(e instanceof HTMLCanvasElement))throw new Error("Video element not found in container.");w={canvas:e,context:e.getContext("2d")};const n=t.querySelector("video");if(!n||!(n instanceof HTMLVideoElement))throw new Error("Video element not found in container.");const r=u=Z(t,o,K.hideNSeekGame);le(r);let a=null;return Promise.all([he,ye(n,e)]).then(([s,i])=>{a=()=>{i()}}),new ResizeObserver(()=>{const{clientWidth:s,clientHeight:i}=t;e.width=s,e.height=i}).observe(t),{destroy(){r.dispose(),a?.()}}};function ye(t,o){let e=null;const n=o?.getContext("2d");if(!n)throw new Error("Cannot get 2D context from canvas.");function r(){if(t.paused||t.ended||t.readyState<2||t.videoWidth===0)return;const{width:a,height:d}=o;if(!a||!d)return;const{videoHeight:s,videoWidth:i}=t,c=Math.max(a/i,d/s);n.save(),n.scale(c,c),n.drawImage(t,0,0,i,s),n.restore()}return O(r),navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1}).then(a=>{t.srcObject=e=a,t.play()}),()=>{W(r),e&&(e.getTracks().forEach(a=>a.stop()),e=null)}}function Me(){b.call?.();const t=new ie,o=u.controls.domElement,e=n=>{if(!l?.model.object||!u)return;const r=o.getBoundingClientRect();t.x=(n.clientX-r.left)/r.width*2-1,t.y=-((n.clientY-r.top)/r.height)*2+1,D.setFromCamera(t,u.camera);const a=D.intersectObject(l.model.object,!0);a.length>0&&(console.log("Found it! Hit:",a[0]),je())};O(R),o.addEventListener("click",e),b.call=()=>{l?.model.object&&(l.model.object.position.set(-.2,.4,0),l.model.object.rotation.set(0,0,0),l.model.object.rotateY(-Math.PI/2),l.model.object.rotateX(-Math.PI/2)),u&&(u.scene.remove(...v),v.length=0),W(R),o.removeEventListener("click",e),b.call=void 0}}function je(){b.call?.(),alert("恭喜找到寵物！"),u.scene.remove(...v),v.length=0}function R(t,o){if(!l?.model.object||!u)return;const e=l.model.object;e.rotation.z=(Math.sin(o/1e3)/3-.5)*Math.PI}var Ce=()=>history.back(),Pe=()=>b.call?.(),_e=I('<button type="button" class="button right svelte-r1w5lc"><img alt="取消" draggable="false" class="svelte-r1w5lc"/> <span class="label svelte-r1w5lc">取消</span></button>'),ke=()=>ge(),Ie=I('<button type="button" class="button right svelte-r1w5lc"><img alt="拍攝" draggable="false" class="svelte-r1w5lc"/> <span class="label svelte-r1w5lc">拍攝</span></button>'),Te=I('<div class="container svelte-r1w5lc"><video autoplay playsinline="" class="svelte-r1w5lc"></video> <canvas id="video" class="svelte-r1w5lc"></canvas> <canvas id="pet" class="svelte-r1w5lc"></canvas> <button type="button" class="button left svelte-r1w5lc"><img alt="返回" draggable="false" class="svelte-r1w5lc"/> <span class="label svelte-r1w5lc">返回</span></button> <!></div>',2);function He(t,o){X(o,!1),ve(),B();var e=Te(),n=y(e);n.muted=!0;var r=x(n,6);r.__click=[Ce];var a=y(r),d=x(r,2);{var s=c=>{var m=_e();m.__click=[Pe];var h=y(m);j(()=>k(h,"src",_.veggieCam.src)),C(c,m)},i=c=>{var m=Ie();m.__click=[ke];var h=y(m);j(()=>k(h,"src",_.veggieCam.src)),C(c,m)};N(d,c=>{b.call?c(s):c(i,!1)})}oe(e,c=>we?.(c)),j(()=>k(a,"src",_.veggieCam.src)),C(t,e),$()}q(["click"]);export{He as default};
