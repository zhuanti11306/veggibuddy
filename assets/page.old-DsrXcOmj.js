import{C as _e,p as De,K as ae,L as Be,I as Ee,f as be,x as Te,u as se,s as E,o as Ae,g as f,M as O,t as Le,i as Fe,j as y,k as re,l as ke,N as Re,h,c as ce,O as $e}from"./index-CiVeqNK5.js";import{V as u,l as Ne,G as ve,B as J,M as qe,h as Ve,m as Ge,n as Ie,P as We,p as Ye,q as Ue,e as Xe,i as U,E as He,Q as le,C as Qe,o as Je,s as ue}from"./GLTFLoader-CQaeW04e.js";import{s as k}from"./class-CNRfvg9s.js";import{b as Ze}from"./input-CY0t1r-S.js";import{c,g as Ke,B as C,a as V,s as we,P as R,b as X,T as de,d as G,e as et,i as tt,r as H,m as ot,f as nt,h as it,j as at,k as st,n as rt}from"./notice-2uxKH9Qy.js";import{Q as me,R as ct}from"./index-DfbJhxeW.js";let s;const n={object:new ve,size:{x:0},visible:!1,box:new J};let m,g,A,l=[],S=new u;async function lt(){console.log("initObject: start"),s=dt(),console.log("initObject: ball created"),await ut(),console.log("initObject: character initialized"),await pt(),console.log("initObject: floor initialized"),Oe(),console.log("initObject: parabola line initialized"),xe(),console.log("initObject: ball position set"),je(),console.log("initObject: character position set"),console.log("initObject: done")}async function ut(){const e=await ye(Ie);n.object.add(e);const t=mt(n.object);n.size={x:t.size.x,y:t.size.y,z:t.size.z},n.box=t.box;const o=1/n.size.x;n.object.scale.setScalar(o),n.visible=!0,V(n.object)}function dt(){let e=new qe(C.geometry,C.material);return e.visible=C.visible,V(e),e}function ye(e){const t=new Ge;return new Promise((o,r)=>{t.load(e,i=>o(i.scene),void 0,i=>r(i))})}function mt(e){let t=new J().setFromObject(e),o=new u;return t.getSize(o),{box:t,size:o}}function xe(){let e=Ke(C.screenPosi.x,C.screenPosi.y,{distance:C.distanceToCam});e.y=Z(e.x,e.z),(!e||isNaN(e.x)||isNaN(e.y)||isNaN(e.z))&&console.error("posi 無效！camera.matrixWorld 還沒更新？"),s.position.copy(e),s.position.y=Math.max(s.position.y,.5)}function je(){n.object.position.copy(s.position),n.object.position.x+=1,n.object.position.z-=1,n.object.position.y+=-n.box.min.y,n.object.lookAt(c.position)}async function pt(){m=new ve;const e=await ye(ct);m.add(e),m.position.set(0,0,0),V(m),ft()}function ft(){if(!(c instanceof We))return;const e=c.position.y-m.position.y,t=c.fov*Math.PI/180,o=2*Math.tan(t/2)*e,r=o*c.aspect;m.scale.set(r,1,o)}const pe=new u,ht=new u(0,-1,0);function Z(e,t){pe.set(e,1e3,t),me.set(pe,ht);const o=me.intersectObject(m,!0);return o.length>0?o[0].point.y:m.position.y}function Oe(){g&&g.visible&&(g.visible=!1),c.getWorldDirection(S),S.normalize(),A=s.position.clone().add(S.multiplyScalar(3));const t=s.geometry;A.y=m.position.y+t.parameters.radius}let fe=new u,T=new u;const gt=new u(0,1,0),he=new u;function bt(e=0,t=0){c.getWorldDirection(S).normalize(),he.crossVectors(S,gt).normalize(),A.addScaledVector(he,e*R.scale),A.addScaledVector(S,t*R.scale),T.copy(A),fe.copy(s.position);const o=s.geometry,r=Z(T.x,T.z);if(T.y=r+o.parameters.radius,l=vt(fe,T),g){const i=g.geometry;i.setFromPoints(l),i.attributes.position.needsUpdate=!0,i.setDrawRange(0,l.length)}else{const i=new Ye().setFromPoints(l);g=new Ue(i,R.material),g.computeLineDistances(),V(g)}g.visible=!0}function vt(e,t){const o=e.clone().lerp(t,.5),r=e.distanceTo(t);o.y+=r*R.ratio;const i=[],b=50;for(let v=0;v<=b;v++){const d=v/b,z=new u().copy(e).multiplyScalar((1-d)*(1-d)).add(o.clone().multiplyScalar(2*(1-d)*d)).add(t.clone().multiplyScalar(d*d));i.push(z)}return i}function wt(){const e=new Ne,t=new Ve;function o(){if(!l.length||!s||!n.object)return;if(t.multiplyMatrices(c.projectionMatrix,c.matrixWorldInverse),e.setFromProjectionMatrix(t),!e.containsPoint(s.position)){n.object.lookAt(c.position),we?.("哎呀！球跑掉了！快動動手機或滑桿，把它找回來吧！",3e3);return}const r=l[0],i=l[l.length-1];if(!r||!i)return;const b=i.clone().sub(r).normalize(),v=new u(0,1,0).cross(b).normalize(),z=s.position.clone().sub(c.position).length(),x=Math.min(z*.1,1),w=s.position.clone().sub(b.clone().multiplyScalar(x)).sub(v.clone().multiplyScalar(de.sideOffset)),M=Z(w.x,w.z),j=new J().setFromObject(n.object),F=j.max.y-j.min.y;w.y=M+F*.3;const _=w.clone().sub(n.object.position),D=_.length();if(D>.1)n.object.lookAt(s.position),n.object.position.add(_.normalize().multiplyScalar(D*de.speed));else{n.object.lookAt(c.position),n.object.position.copy(w),G(()=>{});return}}return o}function yt(){let e=0;function t(){if(!l.length||!s||!m)return;const o=Math.floor(e*(l.length-1)),r=l[o];r&&(s.position.copy(r),s.rotation.x+=X.rotation,s.rotation.y+=X.rotation,e+=X.speed)}return t}let L=!1,$=new Xe,Q=50,N=0,q=0;function xt(e,t){N=0,q=0,L=!0,$.set(e,t),G(()=>{L&&(bt(N,q),N=0,q=0)})}function jt(e,t){L&&(N=e-$.x,q=t-$.y,$.set(e,t))}function Ot(){if(!L)return;L=!1,Oe();const e=yt(),t=wt();G(()=>{e(),t()})}function zt(e){const t=Q-e;Q=e,ot(t*.1)}function ge(){et(),_e("/game")}function Pt(){Q=50,tt(),xe(),je(),H()}class Ct{camera;enabled;alpha=0;beta=0;gamma=0;screenOrientation=0;constructor(t){this.camera=t,this.enabled=!0,window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent.bind(this)),window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent.bind(this)),this.onScreenOrientationChangeEvent()}onDeviceOrientationChangeEvent(t){this.alpha=U.degToRad(t.alpha||0),this.beta=U.degToRad(t.beta||0),this.gamma=U.degToRad(t.gamma||0)}onScreenOrientationChangeEvent(){this.screenOrientation=St()}update(){if(!this.enabled)return;const t=new u(0,0,1),o=new He,r=new le,i=new le(-Math.sqrt(.5),0,0,Math.sqrt(.5));o.set(this.beta,this.alpha,-this.gamma,"YXZ"),this.camera.quaternion.setFromEuler(o),this.camera.quaternion.multiply(i),this.camera.quaternion.multiply(r.setFromAxisAngle(t,-this.screenOrientation))}connect(){this.enabled=!0}disconnect(){this.enabled=!1,window.removeEventListener("deviceorientation",this.onDeviceOrientationChangeEvent),window.removeEventListener("orientationchange",this.onScreenOrientationChangeEvent)}}function St(){return screen.orientation&&typeof screen.orientation.angle=="number"?screen.orientation.angle:window.orientation||0}async function Mt(){await nt(st),await lt(),it(new Qe().setRGB(255,255,255)),H();try{G(()=>{});let e=new Ct(c);at(()=>e.update()),H(),console.log(`[ThreeJS][Game-Throw] Camera position: ${c.position.toArray()}, controls active`)}catch(e){const t=e instanceof Error?e.message:String(e);console.error("[ThreeJS Init] 初始化失敗:",e),we?.(`應用程式啟動失敗！
錯誤訊息: ${t}`,5e3);return}}var _t=be('<div id="loading-spinner" class="svelte-clf2r0"><div class="dot svelte-clf2r0"></div></div>'),Dt=be('<canvas id="gameCanvas" class="svelte-clf2r0"></canvas> <!> <div id="cameraControl"><input id="slideControl" type="range" min="0" max="100" class="svelte-clf2r0"/></div> <button id="resetButton">↺</button> <button id="exitButton">×</button> <div> </div>',1);function kt(e,t){De(t,!1);const o=()=>$e(rt,"$noticeEvent",r),[r,i]=Re();let b=O(!0),v=O(!1),d=O(!1),z=O(!1),x=O(50),w=O(""),M=O(!1);Je(()=>(Mt().then(()=>{h(b,!1),h(v,!0),h(d,!0),h(z,!0)}),ge));let j=!1;function F(a){if(a.target.closest("#cameraControl, #resetButton, #exitButton"))return;j=!0;const{clientX:B,clientY:Me}="touches"in a?a.touches[0]:a;xt(B,Me)}function _(a){if(!j)return;const{clientX:P,clientY:B}="touches"in a?a.touches[0]:a;jt(P,B)}function D(){j&&(j=!1,Ot())}function ze(){h(x,50),Pt()}ae(()=>f(x),()=>{zt(f(x))}),ae(()=>o(),()=>{o()?(h(w,o()),h(M,!0)):h(M,!1)}),Be(),Ee();var K=Dt(),p=Te(K);ue(p,"width",se(()=>window.innerWidth)),ue(p,"height",se(()=>window.innerHeight));var ee=E(p,2);{var Pe=a=>{var P=_t();re(a,P)};Ae(ee,a=>{f(b)&&a(Pe)})}var I=E(ee,2);let te;var Ce=ce(I),W=E(I,2);let oe;var Y=E(W,2);let ne;var ie=E(Y,2),Se=ce(ie);Le((a,P,B)=>{te=k(I,1,"svelte-clf2r0",null,te,a),oe=k(W,1,"svelte-clf2r0",null,oe,P),ne=k(Y,1,"svelte-clf2r0",null,ne,B),k(ie,1,`notice ${f(M)?"show":""}`,"svelte-clf2r0"),Fe(Se,f(w))},[()=>({visible:f(v)}),()=>({visible:f(d)}),()=>({visible:f(z)})]),y("mousedown",p,F),y("mousemove",p,_),y("mouseup",p,D),y("touchstart",p,F),y("touchmove",p,_),y("touchend",p,D),Ze(Ce,()=>f(x),a=>h(x,a)),y("click",W,ze),y("click",Y,function(...a){ge?.apply(this,a)}),re(e,K),ke(),i()}export{kt as default};
