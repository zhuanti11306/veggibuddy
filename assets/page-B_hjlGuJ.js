import{q as B,h as j,A as M,b as _,K as A,l as w,B as N,n as X,M as G,j as D,w as U,a0 as Z,a1 as H,a2 as K,a3 as E,a4 as F,R as q,V as J,a5 as Q,Z as $,p as ee,i as te,C as R,u as ae,O as se,g as oe,d as ne,F as P}from"./vendor-BEoA47yD.js";import{h as re,N as ie,O as ce,R as le,p as k,S as de,B as V,D as Y,w as me,A as he,T as O,z as ue,t as T}from"./settings.svelte-DYu5eymu.js";import{o as x}from"./dialogs-DZWjIJ8s.js";import"./firebase-LKE9M92C.js";var pe=j('<div><p> </p> <p class="hint svelte-alyajq">點擊空白位置以關閉</p></div>');function I(a,s){let e=B(s,"orientation",3,"landscape");var t=pe(),o=w(t),n=w(o);M(()=>{A(t,1,`message ${e()??""}`,"svelte-alyajq"),A(o,1,`content ${s.style??""}`,"svelte-alyajq"),N(n,s.message)}),_(a,t)}let h=null;const{promise:ve,resolve:ge}=Promise.withResolvers(),fe=1,we=1,L=U(()=>k.isLegal?{id:k.type,assets:le[k.type]}:null),{promise:be,resolve:ye}=Promise.withResolvers();let l=null;function Me(){G(()=>{if(!D(L))return void re();const a=D(L).id;Promise.all([ie(a),ve]).then(([s,{scene:e}])=>{const t=s.model.object;t&&(e.add(t),t.position.set(-.2,.4,0),t.rotation.set(0,0,0),t.rotateY(-Math.PI/2),t.rotateX(-Math.PI/2),ye(t)),l?.model.object&&l!==s&&e.remove(l.model.object),l=s})})}let y=null;const p=[];async function _e(){if(!y)return console.warn("[WRN] Video canvas not initialized.");if(!h)return console.warn("[WRN] Scene not initialized.");p.length&&(h.scene.remove(...p),p.length=0);const{width:a,height:s}=y.canvas,{scene:e,camera:t}=h,o=y.context.getImageData(0,0,a,s),n=je(o,t);e.add(n),p.push(n);const{canvas:d}=y;d.toBlob(async r=>{if(r)try{const i=await me(he.imageObjectDetection,{file:r});if(i.hidingPoint&&l?.model.object){const c=Pe(i.mask,n,o,t);e.add(c),p.push(c);const{x:m,y:u}=i.hidingPoint,f=Ce(n,m,u,d.width,d.height),C=n.position.y;l.model.object.position.set(f.x,C,f.z),l.model.object.renderOrder=1,l.model.object.lookAt(t.position),xe()}else x(I,{props:{message:"這裡好像沒有地方可以躲，換個地方拍拍看吧！",style:"failure"}}),e.remove(...p),p.length=0}catch(i){console.error("偵測發生錯誤:",i),x(I,{props:{message:"連線錯誤，請稍後再試",style:"failure"}})}},"image/jpeg")}let g=null,v=null;const b=X({});function je(a,s){g&&(g.geometry.dispose(),Array.isArray(g.material)?g.material.forEach(f=>f.dispose()):g.material.dispose(),h?.scene.remove(g));const e=new Z(a);e.minFilter=H,e.magFilter=H,e.colorSpace=K,e.needsUpdate=!0;const t=fe,o=a.height/a.width*t,n=new E(t,o);n.rotateX(-Math.PI/2);const d=new F({map:e}),r=new q(n,d);r.position.set(0,0,0);const i=s.fov*Math.PI/180,m=o/2/Math.tan(i/2),u=we-m;return r.position.y=u,r.userData={width:t,height:o,distanceToCamera:m,y:u},r.renderOrder=0,g=r,r}function Ce(a,s,e,t,o){const n=a.userData.width,d=a.userData.height,r=s/t-.5,i=e/o-.5,c=r*n,m=i*d;return new J(c,0,m)}function Pe(a,s,e,t){v&&(v.geometry.dispose(),v.material.dispose(),v.removeFromParent());const n=new Q().load(`data:image/png;base64,${a}`),d=s.material.map,r=s.userData,i=.5,c=r.y+i,u=(r.distanceToCamera-i)/r.distanceToCamera,f=r.width*u,C=r.height*u,S=new E(f,C);S.rotateX(-Math.PI/2);const z=new F({map:d,alphaMap:n,transparent:!0,opacity:1,alphaTest:.1});return v=new q(S,z),v.position.set(0,c,0),v.renderOrder=2,v}const ke=function(a){const s=a.querySelector("#pet");if(!s||!(s instanceof HTMLCanvasElement))throw new Error("Canvas element not found in container.");const e=a.querySelector("#video");if(!e||!(e instanceof HTMLCanvasElement))throw new Error("Video element not found in container.");y={canvas:e,context:e.getContext("2d")};const t=a.querySelector("video");if(!t||!(t instanceof HTMLVideoElement))throw new Error("Video element not found in container.");const o=h=ce(a,s,de.hideNSeekGame);ge(o);let n=null;return Promise.all([be,Te(t,e)]).then(([r,i])=>{n=()=>{i()}}),new ResizeObserver(()=>{const{clientWidth:r,clientHeight:i}=a;e.width=r,e.height=i}).observe(a),{destroy(){o.dispose(),n?.()}}};function Te(a,s){let e=null;const t=s?.getContext("2d");if(!t)throw new Error("Cannot get 2D context from canvas.");function o(){if(a.paused||a.ended||a.readyState<2||a.videoWidth===0)return;const{width:n,height:d}=s;if(!n||!d)return;const{videoHeight:r,videoWidth:i}=a,c=Math.max(n/i,d/r);t.save(),t.scale(c,c),t.drawImage(a,0,0,i,r),t.restore()}return V(o),navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1}).then(n=>{a.srcObject=e=n,a.play()}),()=>{Y(o),e&&(e.getTracks().forEach(n=>n.stop()),e=null)}}function xe(){b.call?.();const a=new $,s=h.controls.domElement,e=t=>{if(!l?.model.object||!h)return;const o=s.getBoundingClientRect();a.x=(t.clientX-o.left)/o.width*2-1,a.y=-((t.clientY-o.top)/o.height)*2+1,O.setFromCamera(a,h.camera),O.intersectObject(l.model.object,!0).length>0&&Ie()};V(W),s.addEventListener("click",e),b.call=()=>{l?.model.object&&(l.model.object.position.set(-.2,.4,0),l.model.object.rotation.set(0,0,0),l.model.object.rotateY(-Math.PI/2),l.model.object.rotateX(-Math.PI/2)),h&&(h.scene.remove(...p),p.length=0),Y(W),s.removeEventListener("click",e),b.call=void 0}}function Ie(){b.call?.(),ue("CHAT"),x(I,{props:{message:"恭喜找到寵物！獲得金幣！",style:"success"}}),h.scene.remove(...p),p.length=0}function W(a,s){if(!l?.model.object||!h)return;const e=l.model.object;e.rotation.z=(Math.sin(s/1e3)/3-.5)*Math.PI}var Se=()=>history.back(),Ae=()=>b.call?.(),De=j('<button type="button" class="button right svelte-r1w5lc"><img alt="取消" draggable="false" class="svelte-r1w5lc"/> <span class="label svelte-r1w5lc">取消</span></button>'),He=()=>_e(),Re=j('<button type="button" class="button right svelte-r1w5lc"><img alt="拍攝" draggable="false" class="svelte-r1w5lc"/> <span class="label svelte-r1w5lc">拍攝</span></button>'),Oe=j('<div class="container svelte-r1w5lc"><video autoplay playsinline="" class="svelte-r1w5lc"></video> <canvas id="video" class="svelte-r1w5lc"></canvas> <canvas id="pet" class="svelte-r1w5lc"></canvas> <button type="button" class="button left svelte-r1w5lc"><img alt="返回" draggable="false" class="svelte-r1w5lc"/> <span class="label svelte-r1w5lc">返回</span></button> <!></div>',2);function qe(a,s){ee(s,!1),Me(),te();var e=Oe(),t=w(e);t.muted=!0;var o=R(t,6);o.__click=[Se];var n=w(o),d=R(o,2);{var r=c=>{var m=De();m.__click=[Ae];var u=w(m);M(()=>P(u,"src",T.reset.src)),_(c,m)},i=c=>{var m=Re();m.__click=[He];var u=w(m);M(()=>P(u,"src",T.camera.src)),_(c,m)};ae(d,c=>{b.call?c(r):c(i,!1)})}se(e,c=>ke?.(c)),M(()=>P(n,"src",T.backToGame.src)),_(a,e),oe()}ne(["click"]);export{qe as default};
